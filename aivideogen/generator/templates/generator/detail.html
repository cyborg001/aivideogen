{% extends 'generator/base.html' %}
{% block content %}
<!-- VERSION 4.0 DEFINITIVE FIX -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div>
        <h1>{{ project.title }}</h1>
        <span class="status-badge status-{{ project.status }}" style="font-size: 1rem;">
            {% if project.status == 'pending' %}Pendiente
            {% elif project.status == 'processing' %}Procesando
            {% elif project.status == 'completed' %}Completado
            {% elif project.status == 'failed' or project.status == 'error' %}Fallido
            {% elif project.status == 'cancelled' %}Cancelado
            {% else %}{{ project.status }}{% endif %}
        </span>
    </div>
</div>
<div style="display: flex; gap: 10px; align-items: center;">

    <!-- AUTO UPLOAD TOGGLE (Panic Switch) -->
    <a href="{% url 'generator:toggle_auto_upload' project.id %}" class="btn"
        style="background-color: {% if project.auto_upload_youtube %}#ff0000{% else %}#333{% endif %}; border-color: #555; font-size: 0.9rem; padding: 8px 15px;"
        title="Haz clic para activar/desactivar la subida automática sin reiniciar">
        {% if project.auto_upload_youtube %}🔥 Auto-Upload ON{% else %}⚪ Auto-Upload OFF{% endif %}
    </a>

    <!-- DOWNLOAD JSON -->
    <a href="{% url 'generator:download_project_script_json' project.id %}" class="btn"
        style="background-color: #059669; border: 1px solid #10b981; font-size: 0.9rem; padding: 8px 15px;">
        📥 JSON
    </a>

    <a href="{% url 'generator:project_editor' project.id %}" class="btn"
        style="background-color: #4f46e5; border-color: #4f46e5;">✨ Abrir Editor Visual</a>
</div>

<div class="card">
    {% if project.output_video and project.output_exists %}
    <h3>Video Generado</h3>
    <div class="video-preview"
        style="margin-bottom: 30px; display: flex; justify-content: center; background: #000; border-radius: 10px; overflow: hidden; max-height: 70vh;">
        <video controls style="max-width: 100%; max-height: 70vh; display: block;">
            <source src="{{ project.output_video.url }}" type="video/mp4">
            Tu navegador no soporta el video.
        </video>
    </div>
    <div style="margin-top: 20px; border-top: 1px solid #333; padding-top: 20px;">
        <h4 style="color: #4f46e5; margin-bottom: 15px;">⚙️ Opciones de Render</h4>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <!-- Download -->
            <a href="{{ project.output_video.url }}" download class="btn"
                style="background-color: #22c55e; border-color: #22c55e;">
                📥 Descargar Video
            </a>

            <!-- YouTube -->
            <a href="{% url 'generator:youtube_upload' project.id %}" class="btn" target="_blank"
                style="background-color: #ff0000; border-color: #ff0000;">
                Subir a YouTube
            </a>

            <!-- RE-RENDER (OVERWRITE) -->
            <form action="{% url 'generator:reset_project' project.id %}" method="post"
                onsubmit="return confirm('¿Estás seguro? Se borrará el video actual para generar uno nuevo con los cambios del guion.')">
                {% csrf_token %}
                <button type="submit" class="btn" style="background-color: #f59e0b; border-color: #f59e0b;">
                    🔄 Re-generar (Sobrescribir)
                </button>
            </form>

            <!-- CLONE (NEW VERSION) -->
            <form action="{% url 'generator:clone_project' project.id %}" method="post">
                {% csrf_token %}
                <button type="submit" class="btn" style="background-color: #4f46e5; border-color: #4f46e5;">
                    📑 Crear Nueva Versión
                </button>
            </form>
        </div>
        <p style="font-size: 0.8rem; color: #666; margin-top: 10px;">
            * Usa <b>Sobrescribir</b> si corregiste el guion y quieres arreglar este video. <br>
            * Usa <b>Nueva Versión</b> si quieres probar cambios sin perder el video actual.
        </p>
    </div>
    {% elif project.output_video %}
    <div class="alert alert-warning" style="margin-bottom: 30px;">
        ⚠️ El archivo de video generado ya no existe en el sistema.
    </div>
    {% else %}
    {% if project.status == 'pending' %}
    <div style="text-align: center; padding: 40px; background: #1e1e1e; border-radius: 10px; border: 1px dashed #444;">
        <h2 style="margin-bottom: 20px;">🎬 Proyecto Listo</h2>
        <p style="margin-bottom: 30px; color: #aaa;">El proyecto ha sido creado. Haz clic abajo para comenzar la
            generación del video.</p>

        <form action="{% url 'generator:start_project' project.id %}" method="post">
            {% csrf_token %}
            <button type="submit" class="btn"
                style="background-color: #00e676; color: #000; font-size: 1.2rem; padding: 15px 30px; font-weight: bold; border: none;">
                🚀 Comenzar Generación
            </button>
        </form>
    </div>
    {% elif project.status == 'processing' %}
    <div id="progress-container"
        style="background: #333; height: 10px; border-radius: 5px; margin: 20px 0; overflow: hidden; position: relative;">
        <div id="progress-bar"
            style="background: linear-gradient(90deg, #bb86fc, #03dac6); width: {{ project.progress|default:'0' }}%; height: 100%; transition: width 0.5s;">
        </div>
    </div>
    <div style="text-align: center; font-family: monospace; color: #00ff00; font-weight: bold; margin-bottom: 20px;">
        <span id="progress-text">{{ project.progress|default:'0' }}</span>% completado
    </div>

    <div style="text-align: center; margin-top: 20px;">
        <form action="{% url 'generator:stop_project' project.id %}" method="post">
            {% csrf_token %}
            <button type="submit" class="btn" style="background-color: #ff4444; border-color: #ff4444;">🛑 Detener
                Generación</button>
        </form>
    </div>

    <!-- v12.5: Real-time Polling -->
    <script>
        function updateStatus() {
            fetch("{% url 'generator:api_project_status' project.id %}")
                .then(response => response.json())
                .then(data => {
                    // Update Progress Bar
                    const pBar = document.getElementById('progress-bar');
                    const pText = document.getElementById('progress-text');
                    if (pBar) pBar.style.width = data.progress + '%';
                    if (pText) pText.innerText = data.progress;

                    // Update Logs (if element exists)
                    const logElement = document.getElementById('logs-preview');
                    if (logElement) {
                        // v12.5 Fix: Use textContent for non-input elements
                        if (logElement.tagName === 'INPUT' || logElement.tagName === 'TEXTAREA') {
                            logElement.value = data.log;
                        } else {
                            logElement.textContent = data.log;
                        }
                        logElement.scrollTop = logElement.scrollHeight;
                    }

                    // Reload on completion or failure to update UI state
                    if (data.status === 'completed' || data.status === 'failed' || data.status === 'error' || data.status === 'cancelled') {
                        window.location.reload();
                    }
                })
                .catch(err => console.error("Error polling:", err));
        }

        // Poll every 1.5 seconds
        setInterval(updateStatus, 1500);
    </script>
    {% elif project.status == 'cancelled' or project.status == 'failed' or project.status == 'error' %}
    <div class="alert alert-{% if project.status == 'cancelled' %}info{% else %}danger{% endif %}"
        style="margin-bottom: 20px;">
        {% if project.status == 'cancelled' %}
        🛑 La generación de este video fue detenida manualmente.
        {% else %}
        ❌ La generación de este video falló. Revisa los logs arriba.
        {% endif %}
    </div>

    <div style="display: flex; gap: 10px;">
        <!-- Option 1: Start Again (Overwrite) -->
        <form action="{% url 'generator:reset_project' project.id %}" method="post" style="flex: 1;">
            {% csrf_token %}
            <button type="submit" class="btn" style="width: 100%; height: 100%;">♻️ Reintentar (Limpiar)</button>
        </form>

        <!-- Option 2: Open Editor -->
        <a href="{% url 'generator:project_editor' project.id %}" class="btn"
            style="flex: 1; background-color: #4f46e5; border-color: #4f46e5;">✨ Editar Guion</a>

        <!-- Option 3: Clone -->
        <form action="{% url 'generator:clone_project' project.id %}" method="post" style="flex: 1;">
            {% csrf_token %}
            <button type="submit" class="btn" style="width: 100%; height: 100%; background-color: #6366f1;">📑
                Clonar</button>
        </form>
    </div>
    {% endif %}
    {% endif %}
</div>

{% if social_copy %}
<div class="card" style="border-left: 5px solid #4f46e5; background: #1a1a2e; margin-bottom: 20px;">
    <h3 style="color: #818cf8; display: flex; align-items: center; gap: 10px; margin-top: 0;">
        🚀 Social Copy (Subida Manual)
        <span
            style="font-size: 0.7rem; background: #4f46e5; color: white; padding: 2px 8px; border-radius: 20px; font-weight: normal;">NUEVO</span>
    </h3>
    <p style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 20px;">
        Copia y pega estos textos en YouTube Studio si decides subir el video manualmente.
    </p>

    <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
        <!-- Description -->
        <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label style="font-size: 0.75rem; font-weight: bold; color: #cbd5e1; text-transform: uppercase;">📝
                    Descripción</label>
                <button onclick="copyToClipboard('desc-text', this)" class="btn"
                    style="padding: 2px 10px; font-size: 0.7rem; background: #334155; height: auto;">Copiar</button>
            </div>
            <textarea id="desc-text" placeholder="Escribe aquí la descripción profesional para YouTube..."
                style="width: 100%; height: 120px; background: #0f172a; color: #e2e8f0; border: 1px solid #334155; border-radius: 6px; padding: 10px; font-size: 0.85rem; resize: none; font-family: inherit; transition: border-color 0.2s; outline: none;"
                onfocus="this.style.borderColor='#4f46e5'"
                onblur="this.style.borderColor='#334155'">{{ social_copy.description }}</textarea>
        </div>

        <!-- Tags & Comment Grid -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Tags -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label style="font-size: 0.75rem; font-weight: bold; color: #cbd5e1; text-transform: uppercase;">🏷️
                        Tags (Studio)</label>
                    <button onclick="copyToClipboard('tags-text', this)" class="btn"
                        style="padding: 2px 10px; font-size: 0.7rem; background: #334155; height: auto;">Copiar</button>
                </div>
                <input id="tags-text" placeholder="tag1, tag2, tag3, ai, ciencia..." value="{{ social_copy.tags }}"
                    style="width: 100%; background: #0f172a; color: #22c55e; border: 1px solid #334155; border-radius: 6px; padding: 10px; font-size: 0.85rem; font-family: monospace; transition: border-color 0.2s; outline: none;"
                    onfocus="this.style.borderColor='#4f46e5'" onblur="this.style.borderColor='#334155'">
            </div>

            <!-- Pinned Comment -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label style="font-size: 0.75rem; font-weight: bold; color: #cbd5e1; text-transform: uppercase;">📌
                        Comentario Fijado</label>
                    <button onclick="copyToClipboard('comment-text', this)" class="btn"
                        style="padding: 2px 10px; font-size: 0.7rem; background: #334155; height: auto;">Copiar</button>
                </div>
                <textarea id="comment-text" placeholder="Escribe aquí el comentario fijado para fomentar interacción..."
                    style="width: 100%; height: 80px; background: #0f172a; color: #94a3b8; border: 1px solid #334155; border-radius: 6px; padding: 10px; font-size: 0.85rem; resize: none; font-family: inherit; transition: border-color 0.2s; outline: none;"
                    onfocus="this.style.borderColor='#4f46e5'"
                    onblur="this.style.borderColor='#334155'">{{ social_copy.pinned_comment }}</textarea>
            </div>
        </div>
    </div>
</div>

<script>
    function copyToClipboard(elementId, btn) {
        var copyText = document.getElementById(elementId);
        if (copyText.select) {
            copyText.select();
            copyText.setSelectionRange(0, 99999);
        }
        navigator.clipboard.writeText(copyText.value || copyText.getAttribute('value')).then(() => {
            const originalText = btn.innerText;
            btn.innerText = "¡Copiado!";
            btn.style.background = "#059669";
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.background = "#334155";
            }, 2000);
        });
    }
</script>
{% endif %}

<div class="card">
    <h3>Registro de Proceso (Logs)</h3>
    <pre id="logs-preview"
        style="background: #000; padding: 10px; overflow: auto; max-height: 300px; font-size: 0.9rem; color: #0f0;">{{ project.log_output }}</pre>
</div>

<a href="{% url 'generator:home' %}" class="btn btn-secondary">← Volver</a>
{% endblock %}