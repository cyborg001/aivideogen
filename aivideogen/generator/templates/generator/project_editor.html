{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Visual - {{ project.title }}</title>
    <!-- Tailwind CSS (Localized for Offline Mode) -->
    <script src="{% static 'generator/js/tailwind.min.js' %}"></script>
    <!-- Alpine.js (Localized for Offline Mode) -->
    <script defer src="{% static 'generator/js/alpine.min.js' %}"></script>
    <!-- SortableJS for Drag & Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        [x-cloak] {
            display: none !important;
        }

        /* CustomScrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Toggle Checkbox CSS */
        /* Toggle Switch Improved (v4.6) */
        .toggle-checkbox:checked {
            transform: translateX(100%);
            border-color: #10B981;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #10B981;
        }
    </style>
</head>

<body class="bg-gray-900 text-white h-screen flex flex-col overflow-hidden"
    x-data="scriptEditor({{ project.id|default:'null' }}, '{{ project.title|default:'Nuevo Guion'|escapejs }}', {{ project.music_volume|default:0.15 }}, '{{ project.background_music.file.name|default:''|escapejs }}', '{{ project.voice_id|default:''|escapejs }}', {{ project.auto_upload_youtube|yesno:'true,false' }}, {{ is_standalone|yesno:'true,false' }}, '{{ project.aspect_ratio|default:'landscape' }}', '{{ project.render_mode|default:'cpu' }}', {{ project.music_volume_lock|yesno:'true,false' }}, {{ project.render_workers|default:4 }}, {{ project.dynamic_subtitles|yesno:'true,false' }}, '{{ engine|default:'edge'|escapejs }}')">

    <!-- NAV (Simplified) -->
    <nav class="bg-gray-800 border-b border-gray-700 p-3 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-4">
            <a href="{% url 'generator:home' %}"
                class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-3 py-1 rounded text-sm font-semibold transition flex items-center gap-2">
                <span>üîô</span> Volver
            </a>
            <span class="text-gray-600">|</span>
            <span class="text-xl font-bold text-gray-200">Editor Visual</span>
            <span class="text-gray-600">/</span>
            <span class="text-blue-400 font-mono text-sm truncate max-w-[200px] nav-title">{{ project.title }}</span>
        </div>
        <div class="flex items-center gap-3">
            <!-- File Operations -->
            <input type="file" x-ref="jsonFile" class="hidden" @change="importScript($event)">
            <button @click="$refs.jsonFile.click()"
                class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-gray-300">üìÇ Cargar JSON</button>
            <button @click="openBulkEditor()"
                class="text-xs bg-gray-700 hover:bg-indigo-600 px-2 py-1 rounded text-indigo-200 border border-indigo-500/30">üìù
                Editor de Texto</button>
            <button @click="showSettingsModal = true"
                class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-gray-300">‚öôÔ∏è Configuraci√≥n</button>

            <!-- Aspect Ratio Toggle -->
            <div class="flex bg-gray-700 p-0.5 rounded-lg border border-gray-600">
                <button @click="projectSettings.aspect_ratio = 'landscape'"
                    class="px-2 py-1 rounded transition flex items-center gap-1"
                    :class="projectSettings.aspect_ratio === 'landscape' ? 'bg-blue-600 text-white shadow' : 'text-gray-400 hover:text-gray-200'">
                    <span class="text-xs font-bold">üñ•Ô∏è</span>
                </button>
                <button @click="projectSettings.aspect_ratio = 'portrait'"
                    class="px-2 py-1 rounded transition flex items-center gap-1"
                    :class="projectSettings.aspect_ratio === 'portrait' ? 'bg-purple-600 text-white shadow' : 'text-gray-400 hover:text-gray-200'">
                    <span class="text-xs font-bold">üì±</span>
                </button>
            </div>

            <div class="w-px h-6 bg-gray-600 mx-2"></div>

            <span x-show="isSaving" class="text-yellow-400 text-sm font-mono animate-pulse" x-cloak>Guardando...</span>
            <button @click="saveScript()"
                class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded shadow flex items-center gap-2 font-bold transition">
                <span>üíæ</span> Guardar Guion
            </button>

            <button x-show="isStandalone" @click="saveAsProject()"
                class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded shadow flex items-center gap-2 font-bold transition"
                x-cloak>
                <span>üöÄ</span> Crear Proyecto
            </button>
        </div>
    </nav>

    <!-- EDITOR WORKSPACE -->
    <div class="flex-1 flex overflow-hidden">

        <!-- PANEL LEFT: SCENES TIMELINE -->
        <div class="w-1/2 flex flex-col border-r border-gray-700 bg-gray-900">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-850">
                <h2 class="font-bold text-gray-300">L√≠nea de Tiempo (Escenas)</h2>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-8 pb-20">

                <template x-if="script.blocks">
                    <div id="blocks-container" x-init="setupSortable($el, null, 'blocks')">
                        <template x-for="(block, bIndex) in script.blocks" :key="block._uId || bIndex">
                            <div
                                class="mb-10 border border-gray-700 rounded-xl bg-gray-900/40 overflow-hidden relative group hover:border-gray-600 transition-all shadow-lg">

                                <!-- Block Header -->
                                <div
                                    class="bg-gradient-to-r from-gray-800 to-gray-900 px-5 py-3 flex justify-between items-center border-b border-gray-700 group-hover:border-gray-600">
                                    <div class="flex items-center gap-3 flex-1">
                                        <div
                                            class="cursor-move text-gray-600 hover:text-gray-400 pr-2 border-r border-gray-700 font-bold">
                                            :::</div>
                                        <span
                                            class="text-[10px] font-bold text-blue-400 uppercase tracking-widest bg-blue-500/10 px-2 py-1 rounded border border-blue-500/20">
                                            Bloque <span x-text="bIndex + 1"></span>
                                        </span>
                                        <input type="text" x-model="block.title"
                                            class="bg-transparent border-none text-base font-bold text-gray-200 focus:ring-0 p-0 placeholder-gray-600 focus:text-white transition w-full"
                                            placeholder="T√≠tulo del Bloque (Ej: Intro)">
                                    </div>
                                    <div class="flex items-center gap-1 opacity-60 group-hover:opacity-100 transition">
                                        <!-- Block Settings Button -->
                                        <button @click="openBlockSettings(bIndex)"
                                            class="text-gray-500 hover:text-blue-400 p-2 rounded hover:bg-blue-500/10 transition"
                                            title="Configuraci√≥n del Bloque">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                                                </path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                        </button>
                                        <button
                                            @click="if(confirm('¬øEliminar bloque?')) script.blocks.splice(bIndex, 1)"
                                            class="text-gray-500 hover:text-red-500 p-2 rounded hover:bg-red-500/10 transition"
                                            title="Eliminar Bloque">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                                </path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <!-- Scenes Grid -->
                                <div class="p-4 bg-gray-900/20">
                                    <div class="space-y-3 scenes-container"
                                        x-init="setupSortable($el, bIndex, 'scenes')">
                                        <template x-for="(scene, sIndex) in block.scenes" :key="scene._uId || sIndex">
                                            <div class="bg-gray-800 border border-gray-700 rounded-lg p-3 flex gap-4 hover:border-blue-500/50 hover:bg-gray-800/80 transition relative group/scene cursor-pointer"
                                                @click="openModal(bIndex, sIndex)">

                                                <!-- Index -->
                                                <div
                                                    class="flex-shrink-0 flex flex-col items-center justify-center gap-2 w-6 border-r border-gray-700 pr-2">
                                                    <span class="text-[10px] font-mono text-gray-500"
                                                        x-text="(bIndex+1) + '.' + (sIndex+1)"></span>
                                                    <div class="cursor-move text-gray-700 hover:text-gray-400">:::</div>
                                                </div>

                                                <!-- Content -->
                                                <div class="flex-grow min-w-0 grid grid-cols-12 gap-4">

                                                    <!-- Visual Preview -->
                                                    <div
                                                        class="col-span-2 aspect-video bg-black rounded overflow-hidden relative border border-gray-700/50">
                                                        <template x-if="scene.assets?.[0]">
                                                            <div class="w-full h-full relative">
                                                                <template x-if="isAssetVideo(scene.assets[0])">
                                                                    <video
                                                                        :src="getAssetPath(scene.assets[0]) + '#t=1.0'"
                                                                        class="w-full h-full object-cover opacity-80 transition hover:scale-110"
                                                                        muted playsinline preload="metadata"
                                                                        onmouseover="this.play()"
                                                                        onmouseout="this.pause();"></video>
                                                                </template>
                                                                <template x-if="!isAssetVideo(scene.assets[0])">
                                                                    <img :src="getAssetPath(scene.assets[0])"
                                                                        class="w-full h-full object-cover opacity-80 transition hover:scale-110"
                                                                        onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22/%3E'; this.style.opacity=0.3">
                                                                </template>

                                                                <!-- Video Overlay Icon -->
                                                                <template x-if="isAssetVideo(scene.assets[0])">
                                                                    <div
                                                                        class="absolute inset-0 flex items-center justify-center pointer-events-none bg-black/20">
                                                                        <svg class="w-4 h-4 text-white opacity-70"
                                                                            fill="currentColor" viewBox="0 0 20 20">
                                                                            <path
                                                                                d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.333-5.89a1.5 1.5 0 000-2.538L6.3 2.841z" />
                                                                        </svg>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                        </template>
                                                        <template x-if="!scene.assets?.[0]">
                                                            <div
                                                                class="w-full h-full flex items-center justify-center text-gray-700 bg-gray-800/40">
                                                                <span class="text-xs">üì∫</span>
                                                            </div>
                                                        </template>

                                                        <!-- Badges -->
                                                        <div
                                                            class="absolute bottom-0 right-0 p-0.5 flex flex-wrap justify-end gap-0.5 pointer-events-none max-w-full">

                                                            <!-- SFX Badge -->
                                                            <span x-show="scene.sfx && scene.sfx.length > 0"
                                                                class="bg-orange-600/90 text-[6px] px-1 rounded text-white uppercase tracking-wider font-bold shadow-sm">SFX</span>

                                                            <!-- Overlay Badge -->
                                                            <span x-show="scene.assets?.[0]?.overlay"
                                                                class="bg-purple-600/90 text-[6px] px-1 rounded text-white uppercase tracking-wider font-bold shadow-sm">FX</span>

                                                            <!-- Zoom Badge -->
                                                            <span x-show="scene.assets?.[0]?.zoom"
                                                                class="bg-cyan-600/90 text-[6px] px-1 rounded text-white uppercase tracking-wider font-bold shadow-sm">ZM</span>

                                                            <!-- Move Badge -->
                                                            <span x-show="scene.assets?.[0]?.move"
                                                                class="bg-blue-600/90 text-[6px] px-1 rounded text-white uppercase tracking-wider font-bold shadow-sm">MV</span>
                                                        </div>
                                                    </div>

                                                    <!-- Text Info -->
                                                    <div class="col-span-10 flex flex-col justify-center py-0.5">
                                                        <div class="flex justify-between items-start mb-1">
                                                            <h4 class="text-xs font-bold text-gray-300 truncate pr-4"
                                                                x-text="scene.title || 'Escena ' + (sIndex + 1)"></h4>
                                                            <span
                                                                class="text-[9px] bg-gray-700/50 text-gray-400 px-1.5 rounded"
                                                                x-show="scene.pause > 0"
                                                                x-text="'+' + scene.pause + 's'"></span>
                                                        </div>
                                                        <p class="text-[11px] text-gray-500 line-clamp-1 italic"
                                                            x-text="scene.text || '...'"></p>
                                                    </div>

                                                </div>

                                                <!-- Actions -->
                                                <div
                                                    class="flex flex-col justify-center gap-1 border-l border-gray-700 pl-3 opacity-0 group-hover/scene:opacity-100 transition">
                                                    <button @click.stop="openModal(bIndex, sIndex)"
                                                        class="text-gray-500 hover:text-white" title="Editar">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor"
                                                            viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                                                            </path>
                                                        </svg>
                                                    </button>
                                                    <button
                                                        @click.stop="if(confirm('¬øBorrar?')) deleteScene(bIndex, sIndex)"
                                                        class="text-gray-500 hover:text-red-500" title="Eliminar">
                                                        <svg class="w-3 h-3" fill="none" stroke="currentColor"
                                                            viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                                            </path>
                                                        </svg>
                                                    </button>
                                                </div>

                                            </div>
                                        </template>
                                    </div>


                                    <!-- Groups Grid -->
                                    <template x-for="(group, gIndex) in block.groups" :key="'g'+gIndex">
                                        <div
                                            class="mb-4 mt-6 border border-blue-500/30 rounded-xl bg-blue-900/10 overflow-hidden relative group/group">
                                            <!-- Group Header (Visual Card) -->
                                            <div class="bg-blue-900/20 p-3 border-b border-blue-500/20 flex gap-4">

                                                <!-- Master Asset Thumbnail -->
                                                <div
                                                    class="w-32 aspect-video bg-black rounded overflow-hidden relative border border-blue-500/50 shadow-lg flex-shrink-0 group/poster">
                                                    <template x-if="group.master_asset">
                                                        <div class="w-full h-full relative">
                                                            <!-- v14.3 Fix: Detect Video for Master Asset to avoid Flicker -->
                                                            <!-- v14.4 Fix: Show real frame instead of icon -->
                                                            <template x-if="isAssetVideo(group.master_asset)">
                                                                <video :src="getAssetPath(group.master_asset)"
                                                                    class="w-full h-full object-cover opacity-80"
                                                                    preload="metadata" muted
                                                                    onloadedmetadata="this.currentTime = 1">
                                                                </video>
                                                            </template>
                                                            <template x-if="!isAssetVideo(group.master_asset)">
                                                                <img :src="getAssetPath(group.master_asset)"
                                                                    class="w-full h-full object-cover opacity-80"
                                                                    onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22/%3E'; this.style.opacity=0.3">
                                                            </template>

                                                            <!-- Badges -->
                                                            <div
                                                                class="absolute bottom-0 right-0 p-0.5 flex flex-wrap justify-end gap-0.5 pointer-events-none w-full bg-gradient-to-t from-black/80 to-transparent">
                                                                <span
                                                                    class="bg-blue-600 text-[8px] px-1 rounded text-white font-bold uppercase tracking-wider">MASTER</span>
                                                                <span x-show="group.zoom"
                                                                    class="bg-cyan-600/80 text-[7px] px-1 rounded text-white font-mono"
                                                                    x-text="'ZM ' + group.zoom"></span>
                                                            </div>
                                                        </div>
                                                    </template>
                                                    <template x-if="!group.master_asset">
                                                        <div
                                                            class="w-full h-full flex flex-col items-center justify-center text-blue-500/50 bg-blue-900/20">
                                                            <span class="text-2xl">üìÅ</span>
                                                            <span class="text-[8px] uppercase mt-1">Sin Master</span>
                                                        </div>
                                                    </template>

                                                    <!-- Quick Actions Overlay -->
                                                    <div
                                                        class="absolute inset-0 bg-black/60 opacity-0 group-hover/poster:opacity-100 transition flex items-center justify-center gap-2">
                                                        <button @click.stop="openGroupSettings(bIndex, gIndex)"
                                                            class="text-white hover:text-blue-400"
                                                            title="Configurar Visuales">
                                                            <svg class="w-6 h-6" fill="none" stroke="currentColor"
                                                                viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                                    stroke-width="2"
                                                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                                                                </path>
                                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                                    stroke-width="2"
                                                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- Group Info -->
                                                <div class="flex-1 flex flex-col justify-center">
                                                    <div class="flex justify-between items-start">
                                                        <div>
                                                            <div class="flex items-center gap-2 mb-1">
                                                                <span
                                                                    class="text-[10px] font-bold text-blue-400/80 uppercase tracking-widest border border-blue-500/30 px-1 rounded">GRUPO</span>
                                                                <h3 class="text-sm font-bold text-blue-100"
                                                                    x-text="group.title || 'Grupo ' + (gIndex+1)"></h3>
                                                            </div>
                                                            <p
                                                                class="text-[10px] text-gray-400 font-mono flex items-center gap-2">
                                                                <span x-show="group.move" class="text-blue-300">‚Üî Movie:
                                                                    ON</span>
                                                                <span x-show="!group.move" class="text-gray-600">No
                                                                    Move</span>
                                                                <span class="text-gray-600">|</span>
                                                                <span
                                                                    x-text="(group.scenes ? group.scenes.length : 0) + ' Escenas'"></span>
                                                            </p>
                                                        </div>

                                                        <div class="flex items-center gap-1">
                                                            <button @click.stop="openGroupSettings(bIndex, gIndex)"
                                                                class="text-gray-500 hover:text-white p-2 rounded hover:bg-white/5 transition"
                                                                title="Configurar Setup">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                                    viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                        stroke-width="2"
                                                                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                                                                    </path>
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                        stroke-width="2"
                                                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                                </svg>
                                                            </button>
                                                            <button @click.stop="deleteGroup(bIndex, gIndex)"
                                                                class="text-gray-500 hover:text-red-500 p-2 rounded hover:bg-red-500/10 transition"
                                                                title="Eliminar Grupo">
                                                                <svg class="w-4 h-4" fill="none" stroke="currentColor"
                                                                    viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                        stroke-width="2"
                                                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                                                    </path>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="p-3 space-y-2 group-scenes-container"
                                                x-init="setupSortable($el, bIndex, 'group-scenes', gIndex)">
                                                <template x-for="(scene, sIndex) in group.scenes"
                                                    :key="scene._uId || sIndex">
                                                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-3 flex gap-4 hover:border-blue-500/50 hover:bg-gray-800/80 transition relative group/scene cursor-pointer"
                                                        @click.stop="openModal(bIndex, sIndex, gIndex)">

                                                        <div
                                                            class="flex-shrink-0 flex flex-col items-center justify-center gap-2 w-6 border-r border-gray-700 pr-2">
                                                            <span class="text-[10px] font-mono text-gray-500"
                                                                x-text="(bIndex+1) + '.G' + (gIndex+1) + '.' + (sIndex+1)"></span>
                                                            <div class="cursor-move text-gray-700 hover:text-gray-400">
                                                                :::</div>
                                                        </div>

                                                        <div class="flex-grow min-w-0 grid grid-cols-12 gap-4">
                                                            <div
                                                                class="col-span-2 aspect-video bg-black rounded overflow-hidden relative border border-gray-700/50">
                                                                <template
                                                                    x-if="scene.assets?.[0] || group.master_asset">
                                                                    <div class="w-full h-full relative">
                                                                        <template
                                                                            x-if="isAssetVideo(scene.assets?.[0]?.id || group.master_asset)">
                                                                            <video
                                                                                :src="getAssetPath(scene.assets?.[0]?.id || group.master_asset)"
                                                                                class="w-full h-full object-cover opacity-80"
                                                                                preload="metadata" muted
                                                                                onloadedmetadata="this.currentTime = 1">
                                                                            </video>
                                                                        </template>
                                                                        <template
                                                                            x-if="!isAssetVideo(scene.assets?.[0]?.id || group.master_asset)">
                                                                            <img :src="getAssetPath(scene.assets?.[0]?.id || group.master_asset)"
                                                                                class="w-full h-full object-cover opacity-80"
                                                                                onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22/%3E'; this.style.opacity=0.3">
                                                                        </template>

                                                                    </div>
                                                                </template>
                                                                <template
                                                                    x-if="!scene.assets?.[0] && !group.master_asset">
                                                                    <div
                                                                        class="w-full h-full flex items-center justify-center text-gray-700 bg-gray-800/40">
                                                                        <span class="text-[8px]">üì∫</span>
                                                                    </div>
                                                                </template>
                                                                <div
                                                                    class="absolute bottom-0 right-0 p-0.5 flex flex-wrap justify-end gap-0.5 pointer-events-none max-w-full">
                                                                    <span x-show="scene.sfx && scene.sfx.length > 0"
                                                                        class="bg-orange-600/90 text-[6px] px-1 rounded text-white uppercase tracking-wider font-bold shadow-sm">SFX</span>
                                                                    <span x-show="scene.assets?.[0]?.overlay"
                                                                        class="bg-purple-600/90 text-[6px] px-1 rounded text-white uppercase tracking-wider font-bold shadow-sm">FX</span>
                                                                    <span x-show="scene.assets?.[0]?.zoom"
                                                                        class="bg-cyan-600/90 text-[6px] px-1 rounded text-white uppercase tracking-wider font-bold shadow-sm">ZM</span>
                                                                    <span x-show="scene.assets?.[0]?.move"
                                                                        class="bg-blue-600/90 text-[6px] px-1 rounded text-white uppercase tracking-wider font-bold shadow-sm">MV</span>
                                                                </div>
                                                            </div>

                                                            <div
                                                                class="col-span-10 flex flex-col justify-center py-0.5">
                                                                <div class="flex justify-between items-start mb-1">
                                                                    <h4 class="text-xs font-bold text-gray-300 truncate pr-4"
                                                                        x-text="scene.title || 'Escena ' + (sIndex + 1)">
                                                                    </h4>
                                                                    <span
                                                                        class="text-[9px] bg-gray-700/50 text-gray-400 px-1.5 rounded"
                                                                        x-show="scene.pause > 0"
                                                                        x-text="'+' + scene.pause + 's'"></span>
                                                                </div>
                                                                <p class="text-[11px] text-gray-500 line-clamp-1 italic"
                                                                    x-text="scene.text || '...'"></p>
                                                            </div>
                                                        </div>

                                                        <div
                                                            class="flex flex-col justify-center gap-1 border-l border-gray-700 pl-3 opacity-0 group-hover/scene:opacity-100 transition">
                                                            <button @click.stop="openModal(bIndex, sIndex, gIndex)"
                                                                class="text-gray-500 hover:text-white" title="Editar">
                                                                <svg class="w-3 h-3" fill="none" stroke="currentColor"
                                                                    viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                        stroke-width="2"
                                                                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                                                                    </path>
                                                                </svg>
                                                            </button>
                                                            <button
                                                                @click.stop="if(confirm('¬øBorrar?')) deleteScene(bIndex, sIndex, gIndex)"
                                                                class="text-gray-500 hover:text-red-500"
                                                                title="Eliminar">
                                                                <svg class="w-3 h-3" fill="none" stroke="currentColor"
                                                                    viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                                        stroke-width="2"
                                                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                                                    </path>
                                                                </svg>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </template>
                                                <!-- Add Scene to Group Button -->
                                                <button @click="openModal(bIndex, null, gIndex)"
                                                    class="w-full py-2 bg-blue-900/20 hover:bg-blue-600/10 border-t border-blue-500/20 text-blue-400 hover:text-blue-300 text-[10px] font-bold uppercase tracking-wider transition flex items-center justify-center gap-2 group/btn">
                                                    <span
                                                        class="bg-blue-900/40 group-hover/btn:bg-blue-500 group-hover/btn:text-white text-blue-300 w-4 h-4 rounded-full flex items-center justify-center text-[10px] transition">+</span>
                                                    A√±adir al Master Shot
                                                </button>
                                            </div>
                                        </div>
                                    </template>

                                    <!-- Empty Block State -->
                                    <div x-show="(!block.scenes || block.scenes.length === 0) && (!block.groups || block.groups.length === 0)"
                                        class="text-center py-6 text-gray-600 border border-dashed border-gray-700 rounded-lg text-xs">
                                        Sin escenas en este bloque.
                                    </div>
                                </div>

                                <!-- Add Scene / Group Footer -->
                                <div class="flex border-t border-gray-700 overflow-hidden">
                                    <button @click="openModal(bIndex, null)"
                                        class="flex-1 py-3 bg-gray-800/50 hover:bg-blue-600/10 text-gray-400 hover:text-blue-400 text-[10px] font-bold uppercase tracking-wider transition flex items-center justify-center gap-2 group/btn border-r border-gray-700">
                                        <span
                                            class="bg-gray-700 group-hover/btn:bg-blue-500 group-hover/btn:text-white text-gray-300 w-4 h-4 rounded-full flex items-center justify-center text-xs transition">+</span>
                                        A√±adir Escena
                                    </button>
                                    <button @click="addGroup(bIndex)"
                                        class="flex-1 py-3 bg-gray-800/50 hover:bg-indigo-600/10 text-gray-400 hover:text-indigo-400 text-[10px] font-bold uppercase tracking-wider transition flex items-center justify-center gap-2 group/btn">
                                        <span
                                            class="bg-gray-700 group-hover/btn:bg-indigo-500 group-hover/btn:text-white text-gray-300 w-4 h-4 rounded-full flex items-center justify-center text-xs transition">üé¨</span>
                                        A√±adir Master Shot
                                    </button>
                                </div>
                            </div>
                        </template>

                        <!-- Add Block Button -->
                        <div class="flex justify-center mt-6">
                            <button @click="script.blocks.push({title: 'Nuevo Bloque', scenes: []})"
                                class="px-6 py-3 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-xl border border-gray-600 hover:border-gray-500 flex items-center gap-2 shadow-lg hover:translate-y-[-2px] transition text-sm font-bold">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Nuevo Bloque
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- PANEL RIGHT: PREVIEW AREA -->
        <div
            class="w-1/2 bg-black flex flex-col items-center justify-center border-l border-gray-800 relative bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-gray-900 to-black">

            <div class="text-center p-8 max-w-md">
                <h1
                    class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2">
                    Editor Visual AVGL v3.0</h1>
                <p class="text-gray-500 text-sm mb-6">Gestiona tus escenas, assets y efectos con precisi√≥n. Los cambios
                    se sincronizan directamente con el motor de video.</p>

                {% if project.output_video and project.output_exists %}
                <div class="bg-gray-900 rounded-lg overflow-hidden border border-gray-700 shadow-2xl">
                    <div class="bg-gray-800 px-3 py-1 text-xs text-gray-400 text-left flex justify-between">
                        <span>√öltimo Render</span>
                        <a href="{{ project.output_video.url }}" target="_blank" class="hover:text-white">Abrir ‚Üó</a>
                    </div>
                    <video controls class="w-full max-h-[40vh]">
                        <source src="{{ project.output_video.url }}" type="video/mp4">
                    </video>
                </div>
                {% else %}
                <div class="p-8 border-2 border-dashed border-gray-800 rounded-xl">
                    <span class="text-4xl block mb-2">üé¨</span>
                    <p class="text-gray-600 text-sm">No hay video generado a√∫n.</p>
                </div>
                {% endif %}
            </div>

        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div x-show="showSettingsModal" style="display: none;"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4"
        x-transition.opacity x-cloak>
        <div class="bg-gray-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-md flex flex-col max-h-[95vh] animate-scale"
            @click.away="if (!showRecordModal) showSettingsModal = false">
            <div class="p-6 border-b border-gray-800 shrink-0">
                <h2 class="text-xl font-bold text-gray-200 flex items-center gap-2">
                    <span>‚öôÔ∏è</span> Configuraci√≥n del Proyecto
                </h2>
            </div>

            <div class="p-6 overflow-y-auto flex-1 space-y-4">
                <!-- Project Title -->
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Nombre del Guion</label>
                    <input type="text" x-model="projectSettings.title"
                        class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                </div>

                <!-- Music Volume -->
                <div>
                    <label class="block text-sm text-gray-400 mb-1 flex justify-between">
                        <span>Volumen M√∫sica Global</span>
                        <span class="text-xs font-mono text-blue-400" x-text="projectSettings.music_volume"></span>
                    </label>
                    <input type="range" min="0" max="1" step="0.05" x-model="projectSettings.music_volume"
                        class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                </div>

                <!-- Global Speed -->
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Velocidad de Voz</label>
                    <div class="relative">
                        <input type="number" x-model="voiceSpeedNum" step="1"
                            class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white font-mono text-sm pr-8"
                            placeholder="0">
                        <span class="absolute right-3 top-2 text-gray-500">%</span>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1">Afecta a todo el guion (Ej: 10 = +10%).</p>
                </div>

                <!-- Global Voice ID -->
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Motor de Voz (TTS)</label>
                    <select x-model="projectSettings.engine"
                        class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                        <option value="edge">Edge TTS (Gratis)</option>
                        <option value="elevenlabs">ElevenLabs (Premium)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-1">Voz Global (ID)</label>
                    <input type="text" x-model="projectSettings.voice_id"
                        class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white font-mono placeholder-gray-600 text-xs"
                        placeholder="Ej: es-DO-RamonaNeural">
                    <p class="text-[10px] text-gray-500 mt-1">Sobrescribe la voz por defecto (Alvaro).</p>
                </div>

                <!-- Background Music -->
                <div>
                    <label class="block text-xs uppercase text-gray-400 mb-1">M√∫sica de Fondo (Global)</label>
                    <div class="flex gap-1">
                        <input type="text" x-model="projectSettings.background_music"
                            class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-sm text-white font-mono"
                            placeholder="music/background.mp3">
                        <button @click="browseGlobalMusic()"
                            class="bg-gray-700 hover:bg-gray-600 text-white px-3 rounded"
                            title="Buscar M√∫sica">üìÇ</button>
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1">Ruta relativa a <code>media/music</code> o absoluta.</p>
                </div>

                <!-- Auto-Upload Toggle -->
                <div class="bg-gray-800 p-2 rounded border border-gray-600">
                    <label class="flex items-center justify-between cursor-pointer">
                        <span class="text-sm text-gray-300 font-bold">Auto-Subir a YouTube</span>
                        <div
                            class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" x-model="projectSettings.auto_upload"
                                class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"
                                style="top: 2px; left: 2px; transition: all 0.3s;" />
                            <label
                                class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                        </div>
                    </label>
                    <p class="text-[10px] text-gray-500 mt-1">Si se activa, el video se subir√° autom√°ticamente al
                        terminar.</p>
                </div>

                <!-- Music Volume Lock Toggle (v8.7) -->
                <div class="bg-gray-800 p-2 rounded border border-gray-600">
                    <label class="flex items-center justify-between cursor-pointer">
                        <span class="text-sm text-yellow-300 font-bold">Bloqueo de Volumen Global</span>
                        <div
                            class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" x-model="projectSettings.music_volume_lock"
                                class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"
                                style="top: 2px; left: 2px; transition: all 0.3s;" />
                            <label
                                class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                        </div>
                    </label>
                    <p class="text-[10px] text-gray-500 mt-1">Si se activa, los bloques no podr√°n cambiar el volumen de
                        la m√∫sica de fondo (a menos que tengan m√∫sica propia).</p>
                </div>

                <!-- Global Dynamic Subtitles (Karaoke) Toggle (v16.7.10) -->
                <div class="bg-gray-800 p-2 rounded border border-gray-600">
                    <label class="flex items-center justify-between cursor-pointer">
                        <span class="text-sm text-cyan-300 font-bold">Subt√≠tulos Din√°micos (Karaoke)</span>
                        <div
                            class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" x-model="projectSettings.dynamic_subtitles"
                                class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"
                                style="top: 2px; left: 2px; transition: all 0.3s;" />
                            <label
                                class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                        </div>
                    </label>
                    <p class="text-[10px] text-gray-500 mt-1">Si se activa, TODO el guion usar√° el modo karaoke
                        progresivo
                        autom√°ticamente.</p>
                </div>

                <!-- Hardware Acceleration (v18.0) - Restored by request -->
                <div class="bg-gray-800 p-3 rounded border border-indigo-500/30 shadow-inner">
                    <label class="block text-xs uppercase text-indigo-400 font-bold mb-2">Aceleraci√≥n de
                        Hardware</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button @click="projectSettings.render_mode = 'cpu'"
                            class="flex flex-col items-center justify-center p-2 rounded border transition-all"
                            :class="projectSettings.render_mode === 'cpu' ? 'bg-indigo-600 border-indigo-400 text-white shadow-lg shadow-indigo-500/20' : 'bg-gray-700 border-gray-600 text-gray-400 hover:bg-gray-650'">
                            <span class="text-xl mb-1">üíª</span>
                            <span class="text-[10px] font-bold uppercase">CPU Standard</span>
                        </button>
                        <button @click="projectSettings.render_mode = 'gpu'"
                            class="flex flex-col items-center justify-center p-2 rounded border transition-all"
                            :class="projectSettings.render_mode === 'gpu' ? 'bg-green-600 border-green-400 text-white shadow-lg shadow-green-500/20' : 'bg-gray-700 border-gray-600 text-gray-400 hover:bg-gray-650'">
                            <span class="text-xl mb-1">üöÄ</span>
                            <span class="text-[10px] font-bold uppercase">NVIDIA GPU</span>
                        </button>
                    </div>
                    <p class="text-[9px] text-gray-500 mt-2 text-center italic">El renderizado por GPU requiere drivers
                        de NVIDIA actualizados.</p>
                </div>

            </div>

            <!-- Settings Footer -->
            <div class="p-6 shrink-0 flex justify-end gap-3 border-t border-gray-700">
                <button @click="showSettingsModal = false"
                    class="text-gray-400 hover:text-white px-4 py-2 text-sm uppercase font-bold tracking-wide">Cancelar</button>
                <button @click="saveSettings()"
                    class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded shadow font-bold uppercase tracking-wide transition">
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- SCENE MODAL (Extracted) -->
    <div x-show="showModal" style="display: none;"
        class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4 transition-opacity"
        x-transition.opacity x-cloak>

        <div class="bg-gray-800 w-full max-w-4xl rounded-xl shadow-2xl border border-gray-600 flex flex-col max-h-[90vh] animate-scale"
            @click.away="if (!showRecordModal) closeModal()" x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 scale-90" x-transition:enter-end="opacity-100 scale-100">

            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-gray-700 flex justify-between items-center bg-gray-900 rounded-t-xl">
                <div>
                    <h3 class="text-xl font-bold text-white"
                        x-text="editIndex === null ? 'Nueva Escena' : 'Editar Escena #' + (editIndex + 1)">
                    </h3>
                    <p class="text-xs text-gray-500">Configura los par√°metros visuales y narrativos.</p>
                </div>
                <button @click="closeModal()"
                    class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto flex-1 grid grid-cols-12 gap-6 bg-gray-850">

                <!-- LEFT COL: CONTENT (7 cols) -->
                <div class="col-span-7 space-y-5">

                    <!-- Title -->
                    <div>
                        <label class="block text-xs uppercase text-gray-500 font-bold mb-1">T√≠tulo de
                            Escena</label>
                        <input type="text" x-model="formData.title"
                            class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:border-blue-500 focus:outline-none placeholder-gray-500"
                            placeholder="Ej: Intro, Pilar 1, Conclusi√≥n...">
                    </div>

                    <!-- Script Text -->
                    <div>
                        <label class="block text-xs uppercase text-green-500 font-bold mb-1">Guion (Voz
                            en Off)</label>
                        <div class="relative">
                            <textarea x-model="formData.text" rows="5"
                                class="w-full bg-gray-700 border border-gray-600 rounded p-3 text-sm text-gray-200 focus:border-green-500 focus:outline-none placeholder-gray-500 leading-relaxed font-sans"
                                placeholder="Escribe aqu√≠ lo que dir√° la voz..."></textarea>
                            <div
                                class="absolute bottom-2 right-2 text-[10px] text-gray-500 bg-gray-800 px-1 rounded opacity-70">
                                <span x-text="formData.text.length"></span> cars
                            </div>
                        </div>
                    </div>

                    <!-- Subtitle -->
                    <div class="bg-gray-800 p-3 rounded border border-gray-700/50">
                        <label class="block text-xs uppercase text-purple-400 font-bold mb-1 flex justify-between">
                            <span>Subt√≠tulo de Impacto (v4.1)</span>
                        </label>
                        <div class="flex flex-col gap-2">
                            <input type="text" x-model="formData.subtitle"
                                class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-sm text-white font-bold text-yellow-300"
                                placeholder="Texto del subt√≠tulo">

                            <div class="flex gap-2">
                                <div class="flex-1">
                                    <label class="text-[10px] text-gray-500 block">Duraci√≥n (Palabras)</label>
                                    <input type="number" step="1" x-model="formData.subDur"
                                        class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-xs text-center text-white"
                                        placeholder="3">
                                </div>
                                <div class="flex-1 invisible">
                                    <!-- Hidden but kept in state for compatibility if needed -->
                                    <input type="number" x-model="formData.subDelay">
                                </div>
                                <button @click="insertSubtitleTag()"
                                    class="bg-purple-700 hover:bg-purple-600 text-white px-3 py-1 rounded text-xs font-semibold self-end h-8"
                                    :disabled="!formData.subtitle" title="Insertar antes de la palabra deseada">
                                    + Insertar Tag
                                </button>
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-1">El subt√≠tulo empezar√° en la palabra siguiente al tag y
                            durar√° la cantidad de palabras indicada.</p>
                    </div>

                    <!-- Pause -->
                    <div>
                        <label class="block text-xs uppercase text-gray-500 font-bold mb-1">Pausa Final
                            (seg)</label>
                        <div class="flex items-center gap-4">
                            <input type="range" min="0" max="5" step="0.1" x-model="formData.pause" class="flex-1">
                            <input type="number" step="0.1" x-model="formData.pause"
                                class="w-16 bg-gray-700 border border-gray-600 rounded p-1 text-center font-mono">
                        </div>
                    </div>

                    <!-- Audio Overrides -->
                    <div class="grid grid-cols-2 gap-4 bg-gray-800 p-2 rounded">
                        <div>
                            <label class="block text-[10px] uppercase text-gray-500 font-bold mb-1">Voz
                                (Override)</label>
                            <input type="text" x-model="formData.voice" :title="formData.voice" placeholder="ID Voz"
                                class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-xs text-white">
                        </div>
                        <div>
                            <label class="block text-[10px] uppercase text-gray-500 font-bold mb-1">Tono
                                (Pitch)</label>
                            <input type="text" x-model="formData.pitch" placeholder="+0Hz"
                                class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-xs text-white">
                        </div>
                    </div>

                    <!-- Asset Audio Control (v14.4 - Moved to Left Col for Groups visibility) -->
                    <div x-show="isVideo" class="bg-blue-900/20 p-3 rounded border border-blue-500/20 mt-2"
                        x-transition>
                        <label class="flex items-center justify-between cursor-pointer">
                            <span class="text-xs text-blue-300 font-bold">Mezclar Audio Original (Modo Cine)</span>
                            <div
                                class="relative inline-block w-10 h-6 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" x-model="formData.asset_audio_bool"
                                    class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-2 appearance-none cursor-pointer transition-transform duration-200"
                                    style="top: 2px; left: 2px;" />
                                <label
                                    class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-700 cursor-pointer"></label>
                            </div>
                        </label>
                        <div x-show="formData.asset_audio_bool" class="mt-2 flex items-center gap-2" x-transition>
                            <span class="text-[10px] text-gray-500">Volumen:</span>
                            <input type="range" min="0" max="1" step="0.1" x-model="formData.asset_audio_vol"
                                class="flex-1 h-1">
                            <span class="text-[10px] font-mono text-blue-400"
                                x-text="Math.round((formData.asset_audio_vol || 0.8)*100)+'%'"></span>
                        </div>
                    </div>

                    <!-- CUSTOM AUDIO (New) -->
                    <div class="mt-4 bg-gray-800 p-2 rounded border border-gray-700/50">
                        <label class="block text-xs uppercase text-green-400 font-bold mb-1 flex justify-between">
                            <span>Audio Personalizado (Voz Real)</span>
                            <button @click="showRecordModal = true"
                                class="text-xs text-red-400 hover:text-red-300 flex items-center gap-1">
                                <span>üéôÔ∏è</span> Grabar
                            </button>
                        </label>
                        <div class="flex gap-1">
                            <input type="text" x-model="formData.audio"
                                placeholder="ruta/archivo.mp3 (en assets o media)"
                                class="w-full bg-gray-700 border border-gray-600 rounded p-1 text-xs text-white font-mono">
                            <button @click="browseSceneAudio()"
                                class="bg-gray-700 hover:bg-gray-600 text-white px-2 rounded"
                                title="Buscar Archivo">üìÇ</button>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-1">Si se define, desactiva la voz IA (TTS) para esta
                            escena.</p>
                    </div>

                    <!-- SFX SECTION -->
                    <div class="bg-gray-800 p-3 rounded border border-gray-700/50 mt-4">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-xs uppercase text-orange-400 font-bold">Efectos de Sonido
                                (SFX)</label>
                            <button @click="addSFX()"
                                class="text-[10px] bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-white">+
                                A√±adir</button>
                        </div>

                        <template x-for="(effect, index) in formData.sfx" :key="index">
                            <div class="grid grid-cols-12 gap-2 mb-2 items-center bg-gray-900 p-2 rounded">
                                <div class="col-span-6 flex gap-1">
                                    <input type="text" x-model="effect.type" :title="effect.type"
                                        placeholder="Archivo (ej: boom.mp3)"
                                        class="w-full bg-gray-800 border border-gray-600 rounded p-1 text-xs text-yellow-300 placeholder-gray-600">
                                    <button @click="browseSFX(index)"
                                        class="bg-gray-700 hover:bg-gray-600 text-white px-2 rounded"
                                        title="Buscar Archivo">üìÇ</button>
                                </div>
                                <div class="col-span-3">
                                    <input type="number" step="0.1" x-model="effect.volume" placeholder="Vol"
                                        title="Volumen (0.0 - 1.0)"
                                        class="w-full bg-gray-800 border border-gray-600 rounded p-1 text-xs text-white text-center">
                                </div>
                                <div class="col-span-3 flex gap-1">
                                    <input type="number" step="1" x-model="effect.offset" placeholder="Off"
                                        title="Offset (Palabras)"
                                        class="w-full bg-gray-800 border border-gray-600 rounded p-1 text-xs text-white text-center">
                                    <button @click="removeSFX(index)"
                                        class="text-red-500 hover:text-red-400 font-bold px-1">&times;</button>
                                </div>
                            </div>
                        </template>
                        <div x-show="formData.sfx.length === 0" class="text-center text-[10px] text-gray-600 py-1">
                            Sin efectos de sonido.
                        </div>
                    </div>

                </div>

                <!-- RIGHT COL: VISUALS (5 cols) -->
                <div class="col-span-5 space-y-5 border-l border-gray-700 pl-6 relative">
                    <!-- GROUP LOCK OVERLAY -->
                    <div x-show="editGroupIndex !== null"
                        class="absolute inset-0 bg-gray-900/95 z-20 flex flex-col items-center justify-center text-center p-6 backdrop-blur-sm border-l border-blue-500/30">
                        <span class="text-4xl mb-3">üîí</span>
                        <h4 class="text-blue-300 font-bold uppercase tracking-widest text-sm mb-2">Visuales de Grupo
                        </h4>
                        <p class="text-xs text-gray-400 mb-6 leading-relaxed">
                            Esta escena pertenece a un grupo.<br>
                            Los cambios visuales (Imagen, Zoom, FX) se gestionan desde el <b>Master Asset</b> del grupo.
                        </p>
                        <button
                            @click="closeModal(); setTimeout(() => openGroupSettings(editBlockIndex, editGroupIndex), 300)"
                            class="px-5 py-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded shadow-lg uppercase tracking-wide transform hover:scale-105 transition">
                            Configurar Grupo
                        </button>
                    </div>

                    <h4
                        class="text-sm font-bold text-blue-400 uppercase tracking-widest border-b border-gray-700 pb-2 mb-4">
                        Configuraci√≥n Visual</h4>

                    <!-- Asset Input -->
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Archivo de Asset</label>
                        <div class="flex gap-2">
                            <input type="text" x-model="formData.asset_type" :title="formData.asset_type"
                                class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-xs font-mono text-yellow-300 placeholder-gray-600"
                                placeholder="imagen.png / video.mp4">

                            <!-- BROWSE BUTTON -->
                            <button @click="browseAsset()"
                                class="bg-gray-700 hover:bg-gray-600 border border-gray-600 text-white p-2 rounded"
                                title="Explorar en PC">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z">
                                    </path>
                                </svg>
                            </button>
                        </div>


                        <p class="text-[10px] text-gray-500 mt-1">Debe estar en la carpeta
                            <code>media/assets</code> o ser una ruta absoluta.
                        </p>
                    </div>

                    <!-- Overlay -->
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Overlay (Efecto Capa)</label>
                        <select x-model="formData.overlay"
                            class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-sm text-gray-200 focus:border-blue-500">
                            <option value="">-- Ninguno --</option>
                            <option value="dust">‚ú® Polvo (Dust)</option>
                            <option value="grain">üìΩÔ∏è Grano de Cine (Grain)</option>
                            <option value="light_leaks">‚òÄÔ∏è Fugas de Luz (Light Leaks)</option>
                            <option value="vhs">üìº VHS Glitch</option>
                        </select>
                    </div>

                    <!-- Movement Type -->
                    <div class="bg-gray-800 p-3 rounded border border-gray-700">
                        <label class="block text-xs text-blue-300 mb-2 font-bold">Movimiento de
                            C√°mara</label>

                        <!-- Fit Mode Selection (Radio) -->
                        <div class="mb-3 pb-3 border-b border-gray-700">
                            <label class="block text-[10px] uppercase text-gray-500 font-bold mb-2">Modo de
                                Visualizaci√≥n</label>
                            <div class="flex flex-col gap-2">
                                <!-- Option 1: Cover (Default) -->
                                <label
                                    class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-700 p-1 rounded"
                                    :class="{'opacity-50 cursor-not-allowed': isVideo}">
                                    <input type="radio" name="fit_mode" :checked="formData.fit === false"
                                        @change="formData.fit = false" class="text-blue-500 focus:ring-0"
                                        :disabled="isVideo">
                                    <div>
                                        <span class="text-gray-200 font-bold">Llenar Pantalla (Cover)</span>
                                        <div class="text-[10px] text-gray-500">Recorta bordes para llenar todo.</div>
                                    </div>
                                </label>

                                <!-- Option 2: Fit -->
                                <label
                                    class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-700 p-1 rounded"
                                    :class="{'opacity-50 cursor-not-allowed': isVideo}">
                                    <input type="radio" name="fit_mode" :checked="formData.fit === true"
                                        @change="formData.fit = true" class="text-yellow-500 focus:ring-0"
                                        :disabled="isVideo">
                                    <div>
                                        <span class="text-yellow-300 font-bold">Ajustar Imagen (Fit)</span>
                                        <div class="text-[10px] text-gray-500">Muestra imagen completa con bordes
                                            negros.</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- ZOOM SECTION -->
                        <div class="mb-3 pb-3 border-b border-gray-700" :class="{'opacity-50': isVideo}">
                            <label
                                class="flex items-center gap-2 text-sm cursor-pointer hover:text-white text-gray-200 mb-2">
                                <input type="checkbox" x-model="formData.useZoom"
                                    class="text-blue-500 rounded focus:ring-0" :disabled="isVideo">
                                <span class="font-bold">Zoom (Escala)</span>
                            </label>

                            <div x-show="formData.useZoom" class="pl-6" x-transition>
                                <input type="text" x-model="formData.zoomStr" placeholder="ej: 1.2 o 1.0:1.3"
                                    class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-xs font-mono text-blue-300">
                                <p class="text-[10px] text-gray-500 mt-1">1 valor = fijo | 2 valores (:) = animado</p>
                            </div>
                        </div>

                        <!-- PAN/MOVE SECTION -->
                        <div :class="{'opacity-50': isVideo}">
                            <!-- Horizontal Pan -->
                            <div class="mb-3 pb-3 border-b border-gray-700">
                                <label
                                    class="flex items-center gap-2 text-sm cursor-pointer hover:text-white text-gray-200 mb-2">
                                    <input type="checkbox" x-model="formData.usePanHor"
                                        class="text-green-500 rounded focus:ring-0" :disabled="isVideo">
                                    <span class="font-bold">Paneo Horizontal</span>
                                </label>
                                <div x-show="formData.usePanHor" class="grid grid-cols-2 gap-2 pl-6" x-transition>
                                    <div>
                                        <label class="text-[10px] text-gray-400 block">Inicio (%)</label>
                                        <input type="number" step="10" x-model="formData.panHorStart"
                                            class="w-full bg-gray-900 border border-gray-600 rounded px-1 py-1 text-center font-mono text-xs">
                                    </div>
                                    <div>
                                        <label class="text-[10px] text-gray-400 block">Fin (%)</label>
                                        <input type="number" step="10" x-model="formData.panHorEnd"
                                            class="w-full bg-gray-900 border border-gray-600 rounded px-1 py-1 text-center font-mono text-xs">
                                    </div>
                                </div>
                            </div>

                            <!-- Vertical Pan -->
                            <div class="mb-3">
                                <label
                                    class="flex items-center gap-2 text-sm cursor-pointer hover:text-white text-gray-200 mb-2">
                                    <input type="checkbox" x-model="formData.usePanVer"
                                        class="text-blue-500 rounded focus:ring-0" :disabled="isVideo">
                                    <span class="font-bold">Paneo Vertical</span>
                                </label>
                                <div x-show="formData.usePanVer" class="grid grid-cols-2 gap-2 pl-6" x-transition>
                                    <div>
                                        <label class="text-[10px] text-gray-400 block">Arriba (%)</label>
                                        <input type="number" step="10" x-model="formData.panVerStart"
                                            class="w-full bg-gray-900 border border-gray-600 rounded px-1 py-1 text-center font-mono text-xs">
                                    </div>
                                    <div>
                                        <label class="text-[10px] text-gray-400 block">Abajo (%)</label>
                                        <input type="number" step="10" x-model="formData.panVerEnd"
                                            class="w-full bg-gray-900 border border-gray-600 rounded px-1 py-1 text-center font-mono text-xs">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- FX: SHAKE & ROTATE (v12.1) -->
                    <div class="mt-3 pt-3 border-t border-gray-700 space-y-3" :class="{'opacity-50': isVideo}">
                        <div class="flex items-center justify-between">
                            <label
                                class="flex items-center gap-2 text-sm cursor-pointer hover:text-white text-pink-400 font-bold">
                                <input type="checkbox" x-model="formData.shake"
                                    class="text-pink-500 rounded focus:ring-0" :disabled="isVideo">
                                <span>Efecto SHAKE (Vibraci√≥n)</span>
                            </label>
                        </div>

                        <!-- Shake Parameterize (New v12.1) -->
                        <div x-show="formData.shake" x-transition class="pl-6 space-y-2">
                            <div
                                class="flex justify-between items-center text-[10px] uppercase text-gray-500 font-bold mb-1">
                                <span>Intensidad</span>
                                <span class="text-pink-400 font-mono" x-text="formData.shake_intensity || 5"></span>
                            </div>
                            <input type="range" min="1" max="20" step="1" x-model="formData.shake_intensity"
                                class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-pink-500">
                        </div>

                        <!-- Rotaci√≥n -->
                        <div>
                            <label class="block text-[10px] uppercase text-gray-500 font-bold mb-1 font-mono">Rotaci√≥n
                                (angulo o inicio:fin)</label>
                            <div class="flex gap-2 mb-2">
                                <input type="text" x-model="formData.rotate" placeholder="ej: 15 o 0:720"
                                    :disabled="isVideo"
                                    class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-xs font-mono text-pink-300">
                            </div>
                            <!-- Velocidad Angular v12.4 -->
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-gray-500 font-bold font-mono">w:</span>
                                <input type="number" x-model="formData.w_rotate" placeholder="Vel. Angular (opcional)"
                                    :disabled="isVideo"
                                    class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-xs font-mono text-pink-300">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="isVideo" class="mt-2 text-[10px] text-red-400 italic">
                * Efectos de movimiento desactivados para video.
            </div>

            <!-- Action Buttons (Moved Inside Content) -->
            <div class="col-span-12 mt-8 flex justify-end gap-3 pt-4 border-t border-gray-700/50">
                <button @click="closeModal()"
                    class="text-gray-400 hover:text-white px-4 py-2 text-sm uppercase font-bold tracking-wide">Cancelar</button>
                <button @click="saveScene()"
                    class="group relative px-8 py-3 bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-500 hover:to-blue-500 text-white rounded-xl shadow-lg shadow-indigo-500/30 font-bold uppercase tracking-widest transition-all duration-200 hover:scale-[1.02] active:scale-95 border border-indigo-400/20 overflow-hidden">
                    <div
                        class="absolute inset-0 bg-white/20 group-hover:translate-x-full transition-transform duration-500 -skew-x-12 origin-left">
                    </div>
                    <div class="relative flex items-center gap-2">
                        <span class="text-lg">üíæ</span>
                        <span x-text="editIndex === null ? 'A√±adir Escena' : 'Guardar Cambios'"></span>
                    </div>
                </button>
            </div>
        </div>
    </div>
    </div>


    <!-- BLOCK SETTINGS MODAL -->
    <div x-show="showBlockModal" style="display: none;"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4"
        x-transition.opacity x-cloak>
        <div class="bg-gray-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-sm flex flex-col max-h-[90vh] animate-scale"
            @click.away="if (!showRecordModal) showBlockModal = false">
            <div class="p-6 border-b border-gray-800 shrink-0">
                <h3 class="text-lg font-bold text-gray-200">Configurar Bloque</h3>
            </div>

            <div class="p-6 flex-1 overflow-y-auto space-y-4">
                <div>
                    <label class="block text-xs uppercase text-gray-500 font-bold mb-1">T√≠tulo</label>
                    <input type="text" x-model="blockForm.title"
                        class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white">
                </div>
                <div>
                    <label class="block text-xs uppercase text-gray-500 font-bold mb-1">M√∫sica del Bloque
                        (Opcional)</label>
                    <div class="flex gap-1">
                        <input type="text" x-model="blockForm.music"
                            class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white font-mono text-xs"
                            placeholder="Sobrescribe la m√∫sica global...">
                        <button @click="browseBlockMusic()"
                            class="bg-gray-700 hover:bg-gray-600 text-white px-3 rounded"
                            title="Buscar M√∫sica">üìÇ</button>
                    </div>
                </div>


                <!-- Audio Settings (Block Override) -->
                <div>
                    <label class="block text-xs uppercase text-green-400 font-bold mb-1">Configuraci√≥n de Voz
                        (Bloque)</label>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] text-gray-400 block">Voz ID (Override)</label>
                            <input type="text" x-model="blockForm.voice" placeholder="Global"
                                class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white text-xs">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 block">Velocidad</label>
                            <input type="text" x-model="blockForm.voice_speed" placeholder="+0%"
                                class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white text-xs">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs uppercase text-gray-500 font-bold mb-1 flex justify-between">
                        <span>Volumen</span>
                        <span x-text="blockForm.volume"></span>
                    </label>
                    <input type="range" min="0" max="1" step="0.1" x-model="blockForm.volume" class="w-full">
                </div>
            </div>

            <div class="p-6 shrink-0 flex justify-end gap-2 border-t border-gray-700">
                <button @click="showBlockModal = false"
                    class="text-gray-400 hover:text-white text-xs font-bold uppercase px-3">Cancelar</button>
                <button @click="saveBlockSettings()"
                    class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-xs font-bold uppercase">Guardar</button>
            </div>
        </div>
    </div>

    <!-- GROUP SETTINGS MODAL -->
    <div x-show="showGroupModal" style="display: none;"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4"
        x-transition.opacity x-cloak>
        <div class="bg-gray-900 border border-blue-500/30 rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh] animate-scale"
            @click.away="if (!showRecordModal) showGroupModal = false">
            <div class="p-6 border-b border-gray-700 shrink-0">
                <h3 class="text-lg font-bold text-blue-300">Configurar Grupo</h3>
            </div>

            <div class="p-6 flex-1 overflow-y-auto space-y-4">
                <!-- Title -->
                <div>
                    <label class="block text-xs uppercase text-gray-500 font-bold mb-1">T√≠tulo del Grupo</label>
                    <input type="text" x-model="groupForm.title"
                        class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white">
                </div>

                <!-- Master Asset + Visuals -->
                <div class="bg-gray-800/50 p-3 rounded border border-gray-700">
                    <label class="block text-xs uppercase text-blue-400 font-bold mb-2">Visuales (Maestro)</label>

                    <!-- Asset -->
                    <div class="mb-3">
                        <label class="text-[10px] text-gray-400 block mb-1">Imagen/Video Base</label>
                        <div class="flex gap-1">
                            <input type="text" x-model="groupForm.master_asset"
                                class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white font-mono text-xs text-yellow-300"
                                placeholder="Ruta del archivo...">
                            <button @click="browseGroupAsset()"
                                class="bg-gray-700 hover:bg-gray-600 text-white px-3 rounded"
                                title="Buscar Asset">üìÇ</button>
                        </div>
                    </div>

                    <!-- Visual Effects Grid -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] text-gray-400 block">Efecto / Overlay</label>
                            <select x-model="groupForm.overlay"
                                class="w-full bg-gray-900 border border-gray-600 rounded p-1 text-xs text-white">
                                <option value="">Original</option>
                                <option value="dust">Dust (Polvo)</option>
                                <option value="grain">Film Grain</option>
                                <option value="scratches">Old Film</option>
                                <option value="cinematic">Cinematic</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="flex items-center gap-2 cursor-pointer mt-1">
                                <input type="checkbox" x-model="groupForm.fit"
                                    class="rounded bg-gray-900 border-gray-600">
                                <span class="text-xs text-gray-300">Fit (No Recortar)</span>
                            </label>

                            <!-- Asset Audio Control for Groups (v14.1) -->
                            <div class="bg-blue-900/40 p-1.5 rounded border border-blue-400/20">
                                <label class="flex items-center justify-between cursor-pointer">
                                    <span class="text-[9px] text-blue-300 font-bold uppercase">Audio Original</span>
                                    <div class="relative inline-block w-8 h-4 align-middle select-none">
                                        <input type="checkbox" x-model="groupForm.asset_audio_bool"
                                            class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-2 appearance-none cursor-pointer" />
                                        <label
                                            class="toggle-label block overflow-hidden h-4 rounded-full bg-gray-700 cursor-pointer"></label>
                                    </div>
                                </label>
                                <div x-show="groupForm.asset_audio_bool" class="mt-1 flex items-center gap-1"
                                    x-transition>
                                    <input type="range" min="0" max="1" step="0.1" x-model="groupForm.asset_audio_vol"
                                        class="flex-1 h-0.5">
                                    <span class="text-[8px] font-mono text-blue-400"
                                        x-text="Math.round((groupForm.asset_audio_vol || 0.8)*100)+'%'"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Zoom / Move -->
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <div>
                            <label class="text-[10px] text-gray-400 block">Zoom (Start:End)</label>
                            <input type="text" x-model="groupForm.zoom" placeholder="1.0:1.1"
                                class="w-full bg-gray-900 border border-gray-600 rounded p-1 text-xs text-center font-mono text-white">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">Movimiento (Move)</label>

                            <!-- Hor -->
                            <div class="flex flex-col gap-1 mb-2">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" x-model="groupForm.usePanHor"
                                        class="rounded bg-gray-900 border-gray-600 text-blue-500">
                                    <span class="text-[10px] text-blue-300 font-bold">Horizontal</span>
                                </label>
                                <div x-show="groupForm.usePanHor" class="flex gap-1" x-transition>
                                    <input type="number" step="10" x-model="groupForm.panHorStart" placeholder="0"
                                        class="w-1/2 bg-gray-900 border border-gray-600 rounded p-1 text-[10px] text-center text-white">
                                    <input type="number" step="10" x-model="groupForm.panHorEnd" placeholder="10"
                                        class="w-1/2 bg-gray-900 border border-gray-600 rounded p-1 text-[10px] text-center text-white">
                                </div>
                            </div>

                            <!-- Ver -->
                            <div class="flex flex-col gap-1">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" x-model="groupForm.usePanVer"
                                        class="rounded bg-gray-900 border-gray-600 text-green-500">
                                    <span class="text-[10px] text-green-300 font-bold">Vertical</span>
                                </label>
                                <div x-show="groupForm.usePanVer" class="flex gap-1" x-transition>
                                    <input type="number" step="10" x-model="groupForm.panVerStart" placeholder="0"
                                        class="w-1/2 bg-gray-900 border border-gray-600 rounded p-1 text-[10px] text-center text-white">
                                    <input type="number" step="10" x-model="groupForm.panVerEnd" placeholder="10"
                                        class="w-1/2 bg-gray-900 border border-gray-600 rounded p-1 text-[10px] text-center text-white">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audio Settings -->
                <div class="bg-gray-800/50 p-3 rounded border border-gray-700">
                    <label class="block text-xs uppercase text-green-400 font-bold mb-2">Audio del Grupo</label>

                    <!-- Background Music -->
                    <div class="mb-3">
                        <label class="text-[10px] text-gray-400 block mb-1">M√∫sica de Fondo</label>
                        <div class="flex gap-1">
                            <input type="text" x-model="groupForm.music"
                                class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white font-mono text-xs"
                                placeholder="M√∫sica espec√≠fica...">
                            <button @click="browseGroupMusic()"
                                class="bg-gray-700 hover:bg-gray-600 text-white px-3 rounded"
                                title="Buscar M√∫sica">üéµ</button>
                        </div>
                    </div>

                    <div class="flex gap-4 mb-3">
                        <div class="flex-1">
                            <label class="text-[10px] text-gray-400 block">Volumen M√∫sica</label>
                            <input type="range" min="0" max="1" step="0.05" x-model="groupForm.volume"
                                class="w-full h-1 mt-2">
                        </div>
                        <div class="w-16">
                            <label class="text-[10px] text-gray-400 block text-center"
                                x-text="groupForm.volume"></label>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="text-[10px] text-gray-400 block">Voz (ID Override)</label>
                            <input type="text" x-model="groupForm.voice" placeholder="es-MX-DaliaNeural"
                                class="w-full bg-gray-900 border border-gray-600 rounded p-1 text-xs text-white">
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 block">Velocidad Voz</label>
                            <input type="text" x-model="groupForm.voice_speed" placeholder="+0%"
                                class="w-full bg-gray-900 border border-gray-600 rounded p-1 text-xs text-white">
                        </div>
                    </div>

                    <!-- Custom Audio for Group -->
                    <div class="bg-blue-900/20 p-2 rounded border border-blue-500/20">
                        <label class="block text-[10px] uppercase text-green-400 font-bold mb-1 flex justify-between">
                            <span>Audio Personalizado (Voz Real Grupo)</span>
                            <button @click="showRecordModal = true"
                                class="text-[8px] text-red-400 hover:text-red-300 flex items-center gap-1">
                                <span>üéôÔ∏è</span> Grabar
                            </button>
                        </label>
                        <div class="flex gap-1">
                            <input type="text" x-model="groupForm.audio" placeholder="ruta/archivo.mp3"
                                class="w-full bg-gray-900 border border-gray-600 rounded p-1 text-[10px] text-white font-mono">
                            <button @click="browseGroupAudio()"
                                class="bg-gray-700 hover:bg-gray-600 text-white px-2 rounded"
                                title="Buscar Archivo">üìÇ</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 shrink-0 flex justify-end gap-2 border-t border-gray-700">
                <button @click="showGroupModal = false"
                    class="text-gray-400 hover:text-white text-xs font-bold uppercase px-3">Cancelar</button>
                <button @click="saveGroupSettings()"
                    class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-xs font-bold uppercase">Guardar
                    Grupo</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('scriptEditor', (projectId, initialTitle, initialVol, initialMusicName, initialVoice, initialAutoUpload, isStandalone = false, initialAspectRatio = 'landscape', initialRenderMode = 'cpu', initialMusicLock = false, initialWorkers = 4, initialDynamic = false, initialEngine = 'edge') => ({
                projectId: projectId,
                isStandalone: isStandalone,
                script: {},
                isSaving: false,

                // Modal State
                showModal: false,
                showSettingsModal: false,
                showBlockModal: false,
                showGroupModal: false,
                showBulkModal: false,
                showRecordModal: false,
                editIndex: null,
                editBlockIndex: 0,
                editGroupIndex: null,
                bulkText: '',

                // Block Form
                blockForm: { title: '', music: '', volume: 0.2, master_asset: '' },
                groupForm: {
                    title: '', master_asset: '', overlay: '', fit: false, zoom: '1.0:1.3',
                    usePanHor: false, panHorStart: 0, panHorEnd: 0,
                    usePanVer: false, panVerStart: 0, panVerEnd: 0,
                    music: '', volume: 0.2, voice: '', voice_speed: '', audio: '',
                    asset_audio_bool: false, asset_audio_vol: 0.8
                },

                // Settings Model
                projectSettings: {
                    title: initialTitle,
                    music_volume: initialVol,
                    background_music: initialMusicName,
                    voice_id: initialVoice,
                    auto_upload: initialAutoUpload,
                    aspect_ratio: initialAspectRatio,
                    render_mode: initialRenderMode,
                    voice_speed: '+0%',
                    music_volume_lock: initialMusicLock,
                    music_volume_lock: initialMusicLock,
                    dynamic_subtitles: initialDynamic,
                    engine: initialEngine
                },

                voiceSpeedNum: 0,

                // Form Data Model
                formData: {
                    title: '',
                    asset_type: '',
                    text: '',
                    pause: 0.5,
                    subtitle: '',
                    fit: false,
                    voice: '',
                    pitch: '',
                    overlay: '',
                    asset_audio_bool: false,
                    asset_audio_vol: 0.8,
                    useZoom: false, zoomStart: 1.0, zoomEnd: 1.2,
                    usePan: false, panDir: 'HOR', panStart: 50, panEnd: 50
                },

                // Recording State
                isRecording: false,
                mediaRecorder: null,
                audioChunks: [],
                audioPreviewUrl: null,
                recordingBlob: null,
                recordingTimer: 0,
                recordingInterval: null,

                async startRecording() {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.mediaRecorder = new MediaRecorder(stream);
                        this.audioChunks = [];
                        this.isRecording = true;
                        this.recordingTimer = 0;

                        this.mediaRecorder.ondataavailable = (e) => {
                            if (e.data.size > 0) this.audioChunks.push(e.data);
                        };

                        this.mediaRecorder.onstop = () => {
                            this.recordingBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                            this.audioPreviewUrl = URL.createObjectURL(this.recordingBlob);
                            this.isRecording = false;
                            clearInterval(this.recordingInterval);

                            // Reset preview player if exists
                            this.$nextTick(() => {
                                const player = this.$refs.audioPreview;
                                if (player) {
                                    player.pause();
                                    player.currentTime = 0;
                                    player.load(); // Force reload for new blob
                                }
                            });
                        };

                        this.mediaRecorder.start(200); // v13.5: Use 200ms timeslice for better reliability
                        this.recordingInterval = setInterval(() => { this.recordingTimer++; }, 1000);
                    } catch (err) {
                        alert("Error al acceder al micr√≥fono: " + err);
                    }
                },

                stopRecording() {
                    if (this.mediaRecorder && this.isRecording) {
                        this.mediaRecorder.stop();
                        this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    }
                    // Immediate audio stop
                    const player = this.$refs.audioPreview;
                    if (player) {
                        player.pause();
                        player.currentTime = 0;
                    }
                },

                async uploadRecording() {
                    if (!this.recordingBlob) return;

                    this.isSaving = true;
                    const formData = new FormData();
                    formData.append('audio', this.recordingBlob, 'recording.webm');

                    try {
                        const res = await fetch('/api/voice/upload/', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await res.json();
                        if (data.status === 'success') {
                            // Assign to appropriate field
                            if (this.showModal) {
                                // Scene Edit Modal
                                this.formData.audio = data.path;
                            } else if (this.showSettingsModal) {
                                // Not implemented for global yet, but could be
                            } else if (this.showGroupModal) {
                                this.groupForm.audio = data.path;
                            }

                            this.showRecordModal = false;
                            this.recordingBlob = null;
                            if (this.audioPreviewUrl) URL.revokeObjectURL(this.audioPreviewUrl);
                            this.audioPreviewUrl = null;
                        } else {
                            alert("Error al subir: " + data.message);
                        }
                    } catch (e) {
                        alert("Error de red: " + e);
                    } finally {
                        this.isSaving = false;
                    }
                },

                cancelRecording() {
                    this.showRecordModal = false;
                    this.stopRecording();
                    this.recordingBlob = null;
                    const player = this.$refs.audioPreview;
                    if (player) {
                        player.pause();
                        player.currentTime = 0;
                    }
                    if (this.audioPreviewUrl) URL.revokeObjectURL(this.audioPreviewUrl);
                    this.audioPreviewUrl = null;
                },

                isAssetVideo(path) {
                    if (typeof path === 'object' && path !== null) {
                        path = path.id || path.type || '';
                    }
                    if (typeof path !== 'string') return false;
                    const ext = path.split('.').pop().toLowerCase();
                    return ['mp4', 'mov', 'avi', 'mkv', 'webm'].includes(ext);
                },

                // Getter para el panel de edici√≥n (usa formData.asset_type)
                get isVideo() {
                    return this.isAssetVideo(this.formData.asset_type);
                },

                getAssetPath(asset) {
                    if (!asset) return '';
                    let path = typeof asset === 'string' ? asset : (asset.id || asset.type || '');
                    if (!path) return '';

                    // Normalizar barras (Windows a Web)
                    let normalizedPath = path.replace(/\\/g, '/');

                    // Si ya es una URL absoluta (HTTP), no tocar
                    if (path.startsWith('http')) return path;

                    // Si contiene "/media/", extraer la parte relativa para el navegador
                    if (normalizedPath.includes('/media/')) {
                        return '/' + normalizedPath.substring(normalizedPath.indexOf('media/'));
                    }

                    // Si empieza con "media/", a√±adir / al principio
                    if (normalizedPath.startsWith('media/')) return '/' + normalizedPath;

                    // Si empieza con "assets/", a√±adir /media/ al principio
                    if (normalizedPath.startsWith('assets/')) return '/media/' + normalizedPath;

                    // Si ya es una ruta relativa al root que empieza con /, devolver tal cual
                    if (path.startsWith('/')) return path;

                    // Si es una ruta absoluta de Windows que NO logramos capturar con /media/
                    if (path.match(/^[a-zA-Z]:/)) return '';

                    // Si es solo un nombre de archivo, asumir /media/assets/
                    return '/media/assets/' + path;
                },

                init() {
                    if (this.isStandalone) {
                        // Initialize empty script for standalone mode
                        this.script = {
                            blocks: [{ title: 'Bloque 1', scenes: [] }]
                        };
                        this.projectSettings.title = "Nuevo Guion (Sin Guardar)";
                    } else {
                        this.loadScript();
                        // Auto-save only for Project Mode
                        setInterval(() => { if (!this.showModal && !this.showSettingsModal) this.saveScript(true); }, 60000);
                    }
                },

                setupSortable(el, bIndex, type, gIndex = null) {
                    if (typeof Sortable === 'undefined') {
                        console.warn("SortableJS not loaded yet, retrying...");
                        setTimeout(() => this.setupSortable(el, bIndex, type, gIndex), 500);
                        return;
                    }

                    const options = {
                        animation: 150,
                        handle: '.cursor-move',
                        ghostClass: 'bg-blue-600/20',
                        onEnd: (evt) => {
                            const { oldIndex, newIndex, item, from } = evt;
                            if (oldIndex === newIndex) return;

                            // Revert Sortable DOM move - let Alpine handle it reactively
                            from.insertBefore(item, from.children[oldIndex > newIndex ? oldIndex + 1 : oldIndex]);

                            this.$nextTick(() => {
                                if (type === 'blocks') {
                                    const list = [...this.script.blocks];
                                    const block = list.splice(oldIndex, 1)[0];
                                    list.splice(newIndex, 0, block);
                                    this.script.blocks = list;
                                } else if (type === 'scenes') {
                                    const list = [...this.script.blocks[bIndex].scenes];
                                    const scene = list.splice(oldIndex, 1)[0];
                                    list.splice(newIndex, 0, scene);
                                    this.script.blocks[bIndex].scenes = list;
                                } else if (type === 'group-scenes') {
                                    const list = [...this.script.blocks[bIndex].groups[gIndex].scenes];
                                    const scene = list.splice(oldIndex, 1)[0];
                                    list.splice(newIndex, 0, scene);
                                    this.script.blocks[bIndex].groups[gIndex].scenes = list;
                                }
                                this.saveScript(true);
                            });
                        }
                    };

                    new Sortable(el, options);
                },

                sanitizeScript(data) {
                    if (!data.blocks) data.blocks = [];
                    data.blocks.forEach(block => {
                        if (!block._uId) block._uId = 'b' + Math.random().toString(36).substr(2, 9);
                        if (!block.scenes) block.scenes = [];
                        block.scenes.forEach(scene => {
                            if (!scene._uId) scene._uId = 's' + Math.random().toString(36).substr(2, 9);
                        });
                        if (!block.groups) block.groups = [];
                        block.groups.forEach(group => {
                            if (!group._uId) group._uId = 'g' + Math.random().toString(36).substr(2, 9);
                            if (!group.scenes) group.scenes = [];
                            group.scenes.forEach(scene => {
                                if (!scene._uId) scene._uId = 's' + Math.random().toString(36).substr(2, 9);
                            });
                        });
                    });
                },

                async loadScript() {
                    try {
                        const res = await fetch(`/api/project/${this.projectId}/script/`);
                        const data = await res.json();

                        if (!data.blocks) data.blocks = [{ title: "Bloque Principal", scenes: [] }];
                        this.sanitizeScript(data);

                        // PRESERVE GROUPS + INHERIT ASSETS
                        data.blocks.forEach(block => {
                            if (!block.scenes) block.scenes = [];
                            if (!block.groups) block.groups = [];
                            const blockMasterAsset = block.master_asset;

                            // 1. Apply Block Master Asset to Standard Scenes
                            block.scenes.forEach(scene => {
                                let hasValidAsset = false;
                                if (scene.assets && scene.assets.length > 0) {
                                    const a = scene.assets[0];
                                    const t = (typeof a === 'string') ? a : (a.id || a.type);
                                    if (t && t.trim() !== "" && t.toLowerCase() !== "image" && t.toLowerCase() !== "video") {
                                        hasValidAsset = true;
                                    }
                                }
                                if (blockMasterAsset && !hasValidAsset) {
                                    // v14.8 Fix: Non-destructive inheritance. Only set if empty.
                                    if (!scene.assets || scene.assets.length === 0) {
                                        scene.assets = [blockMasterAsset];
                                    }
                                }
                            });

                            // 2. Apply Group Master Asset In-Place (No Flattening)
                            if (block.groups && Array.isArray(block.groups)) {
                                block.groups.forEach(group => {
                                    const groupMasterAsset = group.master_asset || blockMasterAsset;
                                    if (group.scenes) {
                                        group.scenes.forEach(newScene => {
                                            // Inherit Master Asset Logic
                                            let hasValidAsset = false;
                                            if (newScene.assets && newScene.assets.length > 0) {
                                                const a = newScene.assets[0];
                                                const t = (typeof a === 'string') ? a : (a.id || a.type);
                                                if (t && t.trim() !== "" && t.toLowerCase() !== "image" && t.toLowerCase() !== "video") {
                                                    hasValidAsset = true;
                                                }
                                            }

                                            if (groupMasterAsset && !hasValidAsset) {
                                                // v14.8 Fix: Non-destructive inheritance. 
                                                // If already has an object (even with null ID), preserve it for video_volume
                                                if (!newScene.assets || newScene.assets.length === 0) {
                                                    newScene.assets = [groupMasterAsset];
                                                }
                                            }
                                        });
                                    }
                                });
                            }
                        });

                        if (!data.blocks[0].scenes) data.blocks[0].scenes = [];
                        this.script = data;
                        if (this.script.voice_speed) {
                            this.projectSettings.voice_speed = this.script.voice_speed;
                            try {
                                let val = parseInt(this.script.voice_speed.replace('%', ''));
                                if (!isNaN(val)) this.voiceSpeedNum = val;
                            } catch (e) { }
                        }

                        // Sync Project Settings from Script JSON / Backend Injection (v9.1 Fix)
                        if (data.settings) {
                            if (data.settings.title) this.projectSettings.title = data.settings.title;
                            if (data.settings.background_music) this.projectSettings.background_music = data.settings.background_music;
                            if (data.settings.music_volume !== undefined) this.projectSettings.music_volume = data.settings.music_volume;
                            if (data.settings.voice_id) this.projectSettings.voice_id = data.settings.voice_id;
                            if (data.settings.aspect_ratio) this.projectSettings.aspect_ratio = data.settings.aspect_ratio;
                            if (data.settings.render_mode) this.projectSettings.render_mode = data.settings.render_mode;
                            if (data.settings.music_volume_lock !== undefined) this.projectSettings.music_volume_lock = data.settings.music_volume_lock;
                            if (data.settings.auto_upload !== undefined) this.projectSettings.auto_upload = data.settings.auto_upload;
                            if (data.settings.engine) this.projectSettings.engine = data.settings.engine;

                            // Support for old key names
                            if (data.settings.voice) this.projectSettings.voice_id = data.settings.voice;
                        }

                        // Fallback root sync
                        if (!this.projectSettings.background_music && data.background_music) this.projectSettings.background_music = data.background_music;
                        if (!this.projectSettings.voice_id && data.voice) this.projectSettings.voice_id = data.voice;

                        if (this.script.music_volume_lock !== undefined) {
                            this.projectSettings.music_volume_lock = this.script.music_volume_lock;
                        }
                        this.sanitizeScript(this.script);
                    } catch (e) {
                        console.error("Error loading script:", e);
                    }
                },

                async saveScript(silent = false) {
                    if (!silent) this.isSaving = true;

                    // Sync Settings
                    let sign = this.voiceSpeedNum >= 0 ? '+' : '';
                    this.projectSettings.voice_speed = `${sign}${this.voiceSpeedNum}%`;

                    // CRITICAL FIX: Merge settings into the script object to ensure Root Structure is valid (v9.1)
                    this.script.voice_speed = this.projectSettings.voice_speed;
                    this.script.title = this.projectSettings.title;
                    this.script.music_volume = parseFloat(this.projectSettings.music_volume);
                    this.script.background_music = this.projectSettings.background_music;
                    this.script.voice = this.projectSettings.voice_id;
                    this.script.aspect_ratio = this.projectSettings.aspect_ratio;
                    this.script.render_mode = this.projectSettings.render_mode;
                    this.script.music_volume_lock = this.projectSettings.music_volume_lock;
                    this.script.auto_upload = this.projectSettings.auto_upload;
                    this.script.engine = this.projectSettings.engine;

                    // Also maintain a persistent settings object inside the script
                    if (!this.script.settings) this.script.settings = {};
                    Object.assign(this.script.settings, this.projectSettings);

                    // Payload
                    const payload = {
                        script: this.script,
                        settings: this.projectSettings
                    };

                    // BRANCH LOGIC: Standalone vs Project
                    if (this.isStandalone) {
                        if (silent) return; // Don't auto-save standalone yet (needs file handle context, too complex for now)

                        try {
                            const res = await fetch('/api/script/save_file/', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            const data = await res.json();

                            if (data.status === 'saved') {
                                alert("‚úÖ Guion guardado en: " + data.filename);
                                this.projectSettings.title = data.filename;
                                document.querySelector('.nav-title').innerText = data.filename; // Update UI title manually
                            } else if (data.status === 'cancelled') {
                                // Do nothing
                            } else {
                                alert("Error al guardar: " + data.error);
                            }
                        } catch (e) {
                            alert("Error de conexi√≥n al guardar archivo: " + e);
                        } finally {
                            this.isSaving = false;
                        }
                        return;
                    }

                    // NORMAL PROJECT SAVE
                    try {
                        const res = await fetch(`/api/project/${this.projectId}/script/save/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify(payload)
                        });

                        const text = await res.text();
                        let jsonRes;
                        try { jsonRes = JSON.parse(text); } catch (e) { throw new Error("Invalid JSON"); }

                        if (!jsonRes || jsonRes.error) throw new Error(jsonRes.error || "Unknown error");

                        // Update UI with file info
                        if (jsonRes.title) document.querySelector('.nav-title').innerText = jsonRes.title;

                    } catch (e) {
                        if (!silent && e.message !== "Invalid JSON") alert("Error guardando: " + e.message);
                    } finally {
                        if (!silent) setTimeout(() => { this.isSaving = false; }, 500);
                    }
                },

                async saveAsProject() {
                    this.isSaving = true;
                    try {
                        // Sync Settings before sending
                        let sign = this.voiceSpeedNum >= 0 ? '+' : '';
                        this.projectSettings.voice_speed = `${sign}${this.voiceSpeedNum}%`;

                        // DEEP COPY to avoid reference issues or mutation during stringify
                        const scriptCopy = JSON.parse(JSON.stringify(this.script));

                        // Merge settings into the script copy for the backend to receive a complete V5 JSON
                        scriptCopy.voice_speed = this.projectSettings.voice_speed;
                        scriptCopy.title = this.projectSettings.title;
                        scriptCopy.music_volume = parseFloat(this.projectSettings.music_volume);
                        scriptCopy.background_music = this.projectSettings.background_music;
                        scriptCopy.voice = this.projectSettings.voice_id;
                        scriptCopy.aspect_ratio = this.projectSettings.aspect_ratio;
                        scriptCopy.render_mode = this.projectSettings.render_mode;
                        scriptCopy.engine = this.projectSettings.engine;

                        // Ensure settings object exists
                        if (!scriptCopy.settings) scriptCopy.settings = {};
                        Object.assign(scriptCopy.settings, this.projectSettings);

                        const payload = {
                            script: scriptCopy,
                            settings: this.projectSettings
                        };

                        console.log("üöÄ Enviando payload para crear proyecto:", payload); // Debug

                        const res = await fetch('/project/new/from_editor/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify(payload)
                        });

                        const data = await res.json();
                        if (data.status === 'created') {
                            alert("‚úÖ Proyecto creado con √©xito");
                            // Redirect to the new project editor (linked mode)
                            window.location.href = `/project/${data.project_id}/editor/`;
                        } else {
                            alert("Error: " + data.error);
                        }
                    } catch (e) {
                        alert("Error de conexi√≥n: " + e);
                    } finally {
                        this.isSaving = false;
                    }
                },

                saveSettings() {
                    this.saveScript(this.isStandalone);
                    this.showSettingsModal = false;
                },

                openBlockSettings(index) {
                    this.editBlockIndex = index;
                    const block = this.script.blocks[index];
                    this.blockForm = {
                        title: block.title || '',
                        music: block.music || '',
                        volume: block.volume !== undefined ? block.volume : 0.2,
                        voice: block.voice || '',
                        voice_speed: block.voice_speed || ''
                    };
                    this.showBlockModal = true;
                },

                saveBlockSettings() {
                    const block = this.script.blocks[this.editBlockIndex];
                    block.title = this.blockForm.title;
                    block.music = this.blockForm.music || null;
                    block.volume = parseFloat(this.blockForm.volume);

                    // Audio Override
                    block.voice = this.blockForm.voice || null;
                    block.voice_speed = this.blockForm.voice_speed || null;

                    this.saveScript(this.isStandalone);
                    this.showBlockModal = false;
                },

                // GROUP SETTINGS LOGIC
                openGroupSettings(bIndex, gIndex) {
                    this.editBlockIndex = bIndex;
                    this.editGroupIndex = gIndex;
                    const group = this.script.blocks[bIndex].groups[gIndex];

                    let mAsset = group.master_asset || '';
                    if (typeof mAsset === 'object') {
                        mAsset = mAsset.id || mAsset.path || mAsset.type || '';
                    }

                    this.groupForm = {
                        title: group.title || '',
                        master_asset: mAsset,
                        overlay: group.overlay || '',
                        fit: group.fit || false,
                        zoom: group.zoom || '1.0:1.1',
                        // Split Move Logic
                        usePanHor: false, panHorStart: 0, panHorEnd: 0,
                        usePanVer: false, panVerStart: 0, panVerEnd: 0,

                        music: group.music || '',
                        volume: group.volume !== undefined ? group.volume : 0.2,
                        voice: group.voice || '',
                        voice_speed: group.voice_speed || '',
                        audio: group.audio || '',
                        asset_audio_bool: !!group.video_volume,
                        asset_audio_vol: (typeof group.video_volume === 'number') ? group.video_volume : (group.video_volume ? 1.0 : 0.8)
                    };

                    // Parse existing move string
                    if (group.move) {
                        const moves = group.move.split('+');
                        moves.forEach(m => {
                            const parts = m.trim().split(':');
                            const dim = parts[0];
                            if (dim === 'HOR') {
                                this.groupForm.usePanHor = true;
                                this.groupForm.panHorStart = parseFloat(parts[1]) || 0;
                                this.groupForm.panHorEnd = parseFloat(parts[2]) || 0;
                            } else if (dim === 'VER') {
                                this.groupForm.usePanVer = true;
                                this.groupForm.panVerStart = parseFloat(parts[1]) || 0;
                                this.groupForm.panVerEnd = parseFloat(parts[2]) || 0;
                            }
                        });
                    }
                    this.showGroupModal = true;
                },

                saveGroupSettings() {
                    try {
                        if (this.editBlockIndex === null || this.editGroupIndex === null) {
                            console.error("Indices invalidos en saveGroupSettings");
                            this.showGroupModal = false;
                            return;
                        }

                        const block = this.script.blocks[this.editBlockIndex];
                        if (!block || !block.groups || !block.groups[this.editGroupIndex]) {
                            console.error("Grupo no encontrado en √≠ndices:", this.editBlockIndex, this.editGroupIndex);
                            this.showGroupModal = false;
                            return;
                        }

                        const group = block.groups[this.editGroupIndex];
                        group.title = this.groupForm.title;
                        group.master_asset = this.groupForm.master_asset;
                        group.overlay = this.groupForm.overlay;
                        group.fit = this.groupForm.fit;
                        group.zoom = this.groupForm.zoom;

                        // Reconstruct Move String
                        let moveParts = [];
                        if (this.groupForm.usePanHor) {
                            moveParts.push(`HOR:${this.groupForm.panHorStart}:${this.groupForm.panHorEnd}`);
                        }
                        if (this.groupForm.usePanVer) {
                            moveParts.push(`VER:${this.groupForm.panVerStart}:${this.groupForm.panVerEnd}`);
                        }
                        group.move = moveParts.length > 0 ? moveParts.join(' + ') : '';

                        group.music = this.groupForm.music;
                        group.volume = parseFloat(this.groupForm.volume);
                        group.voice = this.groupForm.voice;
                        group.voice_speed = this.groupForm.voice_speed;
                        group.audio = this.groupForm.audio;
                        group.video_volume = this.groupForm.asset_audio_bool ? parseFloat(this.groupForm.asset_audio_vol) : null;

                        // Apply Visuals to Scenes (Master Shot Interpolation)
                        if (group.scenes && group.scenes.length > 0) {
                            // 1. Calculate Total Weight (Character Count)
                            const totalChars = group.scenes.reduce((sum, s) => sum + (s.text ? s.text.length : 0), 0) || 1;
                            let cumChars = 0;

                            // 2. Parse Group Ranges
                            // Zoom
                            let zStart = 1.0, zEnd = 1.1;
                            const zParts = (group.zoom || '1.0:1.1').split(':');
                            if (zParts.length === 2) { zStart = parseFloat(zParts[0]); zEnd = parseFloat(zParts[1]); }

                            // Pan Hor
                            let hStart = 0, hEnd = 0;
                            if (this.groupForm.usePanHor) {
                                hStart = parseFloat(this.groupForm.panHorStart) || 0;
                                hEnd = parseFloat(this.groupForm.panHorEnd) || 0;
                            }

                            // Pan Ver
                            let vStart = 0, vEnd = 0;
                            if (this.groupForm.usePanVer) {
                                vStart = parseFloat(this.groupForm.panVerStart) || 0;
                                vEnd = parseFloat(this.groupForm.panVerEnd) || 0;
                            }

                            group.scenes.forEach(scene => {
                                const sLen = scene.text ? scene.text.length : 0;
                                // Ratios
                                const rStart = cumChars / totalChars;
                                const rEnd = (cumChars + sLen) / totalChars;

                                // Interpolate Zoom
                                const sZStart = zStart + (zEnd - zStart) * rStart;
                                const sZEnd = zStart + (zEnd - zStart) * rEnd;
                                const sZoom = `${sZStart.toFixed(2)}:${sZEnd.toFixed(2)}`;

                                // Interpolate Move
                                let sMoveParts = [];
                                if (this.groupForm.usePanHor) {
                                    const sHStart = hStart + (hEnd - hStart) * rStart;
                                    const sHEnd = hStart + (hEnd - hStart) * rEnd;
                                    sMoveParts.push(`HOR:${sHStart.toFixed(1)}:${sHEnd.toFixed(1)}`);
                                }
                                if (this.groupForm.usePanVer) {
                                    const sVStart = vStart + (vEnd - vStart) * rStart;
                                    const sVEnd = vStart + (vEnd - vStart) * rEnd;
                                    sMoveParts.push(`VER:${sVStart.toFixed(1)}:${sVEnd.toFixed(1)}`);
                                }
                                const sMove = sMoveParts.join(' + ');

                                // Construct inherited asset object
                                const assetObj = {
                                    id: group.master_asset,
                                    type: group.master_asset,
                                    overlay: group.overlay,
                                    fit: group.fit,
                                    zoom: sZoom,
                                    move: sMove,
                                    video_volume: group.video_volume,
                                    shake: group.shake || false,
                                    rotate: group.rotate || null
                                };
                                // Overwrite scene assets
                                scene.assets = [assetObj];

                                cumChars += sLen;
                            });
                        }

                        this.saveScript(this.isStandalone);
                        this.showGroupModal = false;

                    } catch (e) {
                        console.error("Error cr√≠tico en saveGroupSettings:", e);
                        alert("Error al guardar grupo: " + e.message);
                        // Force close if it was a minor logic error? Maybe better to let user retry.
                    }
                },

                async browseGroupAsset() {
                    try {
                        const res = await fetch('/api/asset/browse/');
                        const data = await res.json();
                        if (data.status === 'success') {
                            this.groupForm.master_asset = data.path;
                        }
                    } catch (e) { alert("Error: " + e); }
                },

                async browseGroupMusic() {
                    try {
                        const res = await fetch('/api/asset/browse/?type=audio');
                        const data = await res.json();
                        if (data.status === 'success') {
                            this.groupForm.music = data.path;
                        }
                    } catch (e) { alert("Error: " + e); }
                },

                async browseGroupAudio() {
                    try {
                        const res = await fetch('/api/asset/browse/?type=audio');
                        const data = await res.json();
                        if (data.status === 'success') {
                            this.groupForm.audio = data.path;
                        }
                    } catch (e) { alert("Error: " + e); }
                },

                async browseBlockAsset() {
                    try {
                        const res = await fetch('/api/asset/browse/');
                        const data = await res.json();
                        if (data.status === 'success') {
                            this.blockForm.master_asset = data.path;
                        }
                    } catch (e) {
                        alert("Error exploring assets: " + e);
                    }
                },

                openModal(blockIndex, sceneIndex = null, groupIndex = null) {
                    if (typeof blockIndex !== 'number' || !this.script.blocks[blockIndex]) {
                        console.error("Invalid block index:", blockIndex);
                        return;
                    }

                    this.editBlockIndex = blockIndex;
                    this.editGroupIndex = groupIndex; // NEW: Support for Groups
                    this.editIndex = sceneIndex;
                    this.showModal = true;

                    if (sceneIndex !== null) {
                        let scene;
                        if (groupIndex !== null) {
                            // Load from Group
                            scene = this.script.blocks[blockIndex].groups[groupIndex].scenes[sceneIndex];
                        } else {
                            // Load from Standard Scenes
                            scene = this.script.blocks[blockIndex].scenes[sceneIndex];
                        }

                        let asset = scene.assets && scene.assets.length > 0 ? scene.assets[0] : null;

                        // v14.6: Fallback to Group Master Asset if in Group and no scene asset ID
                        // NON-DESTRUCTIVE: We only use the group ID for the UI if the scene has no asset ID
                        const displayAssetPath = (asset && asset.id) ? asset.id : (groupIndex !== null ? this.script.blocks[blockIndex].groups[groupIndex].master_asset : '');

                        if (!asset) asset = {};

                        // Parse Subtitle for UI (Word-Based Sync v3.2)
                        // Note: If multiple subs exist, we load the first one into the editor fields for quick tweaking
                        let subTxt = '';
                        let subDurVal = 3;

                        // Check if new list exists
                        if (scene.subtitles && scene.subtitles.length > 0) {
                            const firstSub = scene.subtitles[0];
                            subTxt = firstSub.text;
                            subDurVal = firstSub.word_count || firstSub.duration || 3;
                        } else if (scene.subtitle && scene.subtitle.includes('|')) {
                            // Fallback for old pipe syntax
                            const p = scene.subtitle.split('|');
                            subTxt = p[0].trim();
                            subDurVal = parseFloat(p[p.length - 1]) || 3;
                        } else {
                            subTxt = scene.subtitle || '';
                        }

                        this.formData = {
                            title: scene.title || '',
                            asset_type: displayAssetPath,
                            text: scene.text || '',
                            pause: scene.pause || 0.5,
                            subtitle: subTxt,
                            subDur: subDurVal,
                            subDelay: 0.0, // Deprecated in UI

                            // Advanced
                            voice: scene.voice || '',
                            audio: scene.audio || '',
                            pitch: scene.pitch || '',

                            // Visual FX
                            overlay: (asset.overlay || '').replace('.mp4', '').replace('.mov', ''),
                            fit: asset.fit || false,
                            asset_audio_bool: asset.video_volume !== null && asset.video_volume !== undefined,
                            asset_audio_vol: (typeof asset.video_volume === 'number') ? asset.video_volume : 0.8,
                            useZoom: !!asset.zoom,
                            zoomStr: asset.zoom || '1.0',

                            // Split Pan logic for Diagonal support
                            usePanHor: false, panHorStart: 50, panHorEnd: 50,
                            usePanVer: false, panVerStart: 50, panVerEnd: 50,

                            // SFX Support
                            sfx: scene.sfx ? JSON.parse(JSON.stringify(scene.sfx)) : [],

                            // Camera FX (v12.4)
                            shake: asset.shake || false,
                            shake_intensity: asset.shake_intensity || 5,
                            rotate: asset.rotate || '',
                            w_rotate: asset.w_rotate || ''
                        };


                        // Load Move (Search for HOR and VER independently)
                        if (asset.move) {
                            // Example: "HOR:0:100 + VER:50:50" or just "HOR:0:100"
                            const moves = asset.move.split('+');

                            moves.forEach(m => {
                                const parts = m.trim().split(':');
                                const dim = parts[0]; // HOR or VER
                                if (dim === 'HOR') {
                                    this.formData.usePanHor = true;
                                    this.formData.panHorStart = parseFloat(parts[1]);
                                    this.formData.panHorEnd = parseFloat(parts[2]);
                                } else if (dim === 'VER') {
                                    this.formData.usePanVer = true;
                                    this.formData.panVerStart = parseFloat(parts[1]);
                                    this.formData.panVerEnd = parseFloat(parts[2]);
                                }
                            });
                        }

                    } else {
                        // Reset New
                        this.formData = {
                            title: '',
                            asset_type: '',
                            text: '',
                            pause: 1.0,
                            subtitle: '',
                            subDur: 3,
                            subDelay: 0.0,
                            voice: '',
                            audio: '',
                            pitch: '',
                            fit: false,
                            overlay: '',
                            asset_audio_bool: false,
                            asset_audio_vol: 0.8,

                            useZoom: true,
                            zoomStart: 1.0,
                            zoomEnd: 1.2,

                            usePanHor: false, panHorStart: 50, panHorEnd: 50,
                            usePanVer: false, panVerStart: 50, panVerEnd: 50,

                            sfx: [],
                            shake: false,
                            shake_intensity: 5,
                            rotate: ''
                        };
                    }
                },

                closeModal() {
                    this.showModal = false;
                },

                insertSubtitleTag() {
                    if (this.formData.subtitle) {
                        // Syntax v4.1: [SUB: palabras | texto]
                        let tag = ` [SUB: ${Math.round(this.formData.subDur || 3)} | ${this.formData.subtitle}] `;

                        // Insert at cursor position
                        const textarea = document.querySelector('textarea[x-model="formData.text"]');
                        if (textarea) {
                            const start = textarea.selectionStart;
                            const end = textarea.selectionEnd;
                            const text = this.formData.text;
                            this.formData.text = text.substring(0, start) + tag + text.substring(end);

                            // Restore focus
                            this.$nextTick(() => {
                                textarea.focus();
                                textarea.selectionStart = textarea.selectionEnd = start + tag.length;
                            });
                        } else {
                            this.formData.text += tag;
                        }
                    }
                },

                addSFX() {
                    this.formData.sfx.push({
                        type: '', // Filename
                        volume: 0.5,
                        offset: 0 // In words (approx)
                    });
                },

                removeSFX(index) {
                    this.formData.sfx.splice(index, 1);
                },

                saveScene() {
                    // 1. Build Asset Object
                    let currentZoom = this.formData.useZoom ? (this.formData.zoomStr || '1.0') : null;

                    // Build Move String (Combine HOR + VER)
                    let moveParts = [];
                    if (this.formData.usePanHor) {
                        moveParts.push(`HOR:${this.formData.panHorStart}:${this.formData.panHorEnd}`);
                    }
                    if (this.formData.usePanVer) {
                        moveParts.push(`VER:${this.formData.panVerStart}:${this.formData.panVerEnd}`);
                    }
                    let moveStr = moveParts.length > 0 ? moveParts.join(' + ') : null;

                    const isInGroup = this.editGroupIndex !== null;
                    const assetObj = {
                        id: isInGroup ? null : this.formData.asset_type,
                        type: this.isAssetVideo(this.formData.asset_type || '') ? 'video' : 'image',
                        zoom: isInGroup ? null : currentZoom,
                        move: isInGroup ? null : moveStr,
                        overlay: this.formData.overlay || null,
                        fit: isInGroup ? false : this.formData.fit,
                        video_volume: this.formData.asset_audio_bool ? parseFloat(this.formData.asset_audio_vol) : null,
                        shake: isInGroup ? false : (this.formData.shake || false),
                        shake_intensity: isInGroup ? 0 : parseInt(this.formData.shake_intensity || 5),
                        rotate: isInGroup ? null : (this.formData.rotate || null),
                        w_rotate: isInGroup ? null : (this.formData.w_rotate || null)
                    };

                    // 2. Build Scene Object
                    const newScene = {
                        title: this.formData.title,
                        text: this.formData.text,
                        pause: parseFloat(this.formData.pause),
                        subtitle: this.formData.subtitle,
                        voice: this.formData.voice || null,
                        audio: this.formData.audio || null,
                        pitch: this.formData.pitch || null,
                        assets: [assetObj],
                        sfx: this.formData.sfx // Save SFX array
                    };

                    // 3. Update Script Model
                    // 3. Update Script Model
                    let sceneList;
                    if (this.editGroupIndex !== null) {
                        // Target: Group Scenes
                        // Ensure scenes array exists in group
                        if (!this.script.blocks[this.editBlockIndex].groups[this.editGroupIndex].scenes) {
                            this.script.blocks[this.editBlockIndex].groups[this.editGroupIndex].scenes = [];
                        }
                        sceneList = this.script.blocks[this.editBlockIndex].groups[this.editGroupIndex].scenes;
                    } else {
                        // Target: Standard Scenes
                        sceneList = this.script.blocks[this.editBlockIndex].scenes;
                    }

                    if (this.editIndex !== null) {
                        // Edit existing
                        sceneList[this.editIndex] = newScene;
                    } else {
                        // Add new
                        sceneList.push(newScene);
                    }

                    // Reactivity Trigger
                    if (this.editGroupIndex !== null) {
                        this.script.blocks[this.editBlockIndex].groups[this.editGroupIndex].scenes = [...sceneList];
                    } else {
                        this.script.blocks[this.editBlockIndex].scenes = [...sceneList];
                    }

                    this.saveScript(this.isStandalone);
                    this.closeModal();
                },

                deleteScene(blockIndex, sceneIndex, groupIndex = null) {
                    if (confirm("¬øSeguro que quieres borrar esta escena?")) {
                        if (groupIndex !== null) {
                            this.script.blocks[blockIndex].groups[groupIndex].scenes.splice(sceneIndex, 1);
                        } else {
                            this.script.blocks[blockIndex].scenes.splice(sceneIndex, 1);
                        }
                        this.saveScript(this.isStandalone);
                    }
                },

                duplicateScene(blockIndex, sceneIndex) {
                    const scene = this.script.blocks[blockIndex].scenes[sceneIndex];
                    const copy = JSON.parse(JSON.stringify(scene)); // Deep copy
                    copy.title += " (Copia)";
                    this.script.blocks[blockIndex].scenes.splice(sceneIndex + 1, 0, copy);
                    this.saveScript(this.isStandalone);
                },

                addBlock() {
                    this.script.blocks.push({
                        title: 'Nuevo Bloque',
                        scenes: [],
                        groups: []
                    });
                    this.saveScript(this.isStandalone);
                },

                addGroup(blockIndex) {
                    if (!this.script.blocks[blockIndex].groups) {
                        this.script.blocks[blockIndex].groups = [];
                    }
                    this.script.blocks[blockIndex].groups.push({
                        title: 'Nuevo Master Shot',
                        master_asset: '',
                        zoom: '1.0:1.3',
                        move: 'HOR:50:50',
                        scenes: []
                    });
                    this.saveScript(this.isStandalone);
                },

                deleteGroup(blockIndex, groupIndex) {
                    if (confirm('¬øEliminar este Grupo Master Shot y sus escenas?')) {
                        this.script.blocks[blockIndex].groups.splice(groupIndex, 1);
                        this.saveScript(this.isStandalone);
                    }
                },

                deleteBlock(index) {
                    if (confirm('¬øBorrar bloque y sus escenas?')) {
                        this.script.blocks.splice(index, 1);
                        this.saveScript(this.isStandalone);
                    }
                },

                async openBulkEditor() {
                    this.isSaving = true; // Show loading
                    try {
                        const res = await fetch('/api/script/json_to_text/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.script)
                        });
                        const data = await res.json();
                        if (data.text) {
                            this.bulkText = data.text;
                            this.showBulkModal = true;
                        } else {
                            alert("Error al convertir script.");
                        }
                    } catch (e) {
                        alert("Error de conexi√≥n: " + e);
                    } finally {
                        this.isSaving = false;
                    }
                },

                async saveBulkEditor() {
                    this.isSaving = true;
                    try {
                        const res = await fetch('/api/script/text_to_json/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text: this.bulkText, title: this.projectSettings.title })
                        });
                        const data = await res.json();
                        if (data.blocks) {
                            this.sanitizeScript(data);
                            this.script = data;
                            this.showBulkModal = false;
                            this.saveScript(true); // Persist instantly (silently)
                        } else {
                            alert("Error al procesar el texto. Revisa el formato.");
                        }
                    } catch (e) {
                        alert("Error de conexi√≥n: " + e);
                    } finally {
                        this.isSaving = false;
                    }
                },

                importScript(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            if (!json.blocks && !json.scenes) throw new Error("Formato JSON inv√°lido");

                            if (!json.blocks) json.blocks = [{ title: "Bloque Importado", scenes: json.scenes || [] }];

                            // PRESERVE GROUPS + INHERIT ASSETS
                            json.blocks.forEach(block => {
                                if (!block.scenes) block.scenes = [];
                                if (!block.groups) block.groups = [];

                                // Apply Master Asset In-Place
                                if (block.groups && Array.isArray(block.groups)) {
                                    block.groups.forEach(group => {
                                        const masterAsset = group.master_asset;
                                        if (group.scenes) {
                                            group.scenes.forEach(newScene => {
                                                let hasValidAsset = false;
                                                if (newScene.assets && newScene.assets.length > 0) {
                                                    const a = newScene.assets[0];
                                                    const t = a.id || a.type;
                                                    if (t && t.trim() !== "" && t.toLowerCase() !== "image" && t.toLowerCase() !== "video") {
                                                        hasValidAsset = true;
                                                    }
                                                }

                                                if (masterAsset && !hasValidAsset) {
                                                    newScene.assets = [masterAsset];
                                                }
                                            });
                                        }
                                    });
                                }
                            });

                            this.sanitizeScript(json);
                            this.script = json;
                            // Sync settings from imported script
                            if (json.title) this.projectSettings.title = json.title;
                            if (json.voice) this.projectSettings.voice_id = json.voice;
                            if (json.voice_speed) this.projectSettings.voice_speed = json.voice_speed;
                            if (json.background_music) this.projectSettings.background_music = json.background_music;
                            if (json.auto_upload !== undefined) this.projectSettings.auto_upload = json.auto_upload;

                            this.saveScript(this.isStandalone);
                            alert("‚úÖ Guion cargado correctamente.");
                        } catch (err) {
                            alert("Error cargando JSON: " + err.message);
                        }
                    };
                    reader.readAsText(file);
                    event.target.value = '';
                },

                // Music Browsers
                async browseGlobalMusic() {
                    try {
                        const res = await fetch('/api/asset/browse/?type=audio');
                        const data = await res.json();
                        if (data.status === 'success') {
                            this.projectSettings.background_music = data.path;
                        }
                    } catch (e) {
                        alert("Error: " + e);
                    }
                },

                async browseBlockMusic() {
                    try {
                        const res = await fetch('/api/asset/browse/?type=audio');
                        const data = await res.json();
                        if (data.status === 'success') {
                            this.blockForm.music = data.path;
                        }
                    } catch (e) {
                        alert("Error: " + e);
                    }
                },

                // New: Browse Local Asset
                async browseSFX(index) {
                    try {
                        const res = await fetch('/api/asset/browse/?type=audio');
                        const data = await res.json();
                        if (data.status === 'success') {
                            this.formData.sfx[index].type = data.path;
                        }
                    } catch (e) {
                        alert("Error abriendo buscador: " + e);
                    }
                },

                // UTILITY: Sanitize Script Assets (v4.16 Repair Tool)
                sanitizeScript(scriptObj) {
                    if (!scriptObj || !scriptObj.blocks) return;
                    scriptObj.blocks.forEach(block => {
                        // 1. Sanitize Standard Scenes
                        if (block.scenes) {
                            block.scenes.forEach(scene => this.sanitizeSceneAssets(scene));
                        }
                        // 2. Sanitize Group Scenes
                        if (block.groups) {
                            block.groups.forEach(group => {
                                if (group.scenes) {
                                    group.scenes.forEach(scene => this.sanitizeSceneAssets(scene));
                                }
                            });
                        }
                    });
                },

                // Helper for asset repair
                sanitizeSceneAssets(scene) {
                    if (!scene.assets) return;
                    scene.assets.forEach(asset => {
                        // Repair filenames hidden in 'type'
                        if ((!asset.id || asset.id === 'image' || asset.id === 'video') &&
                            (asset.type && asset.type.includes('.'))) {
                            asset.id = asset.type;
                            asset.type = (asset.id.toLowerCase().endsWith('.mp4') || asset.id.toLowerCase().endsWith('.mov')) ? 'video' : 'image';
                        }
                        // Ensure ID is never 'image' if type is what we really want
                        if (asset.id === 'image' && asset.type && asset.type.includes('.')) {
                            asset.id = asset.type;
                            asset.type = 'image';
                        }
                    });
                },

                async browseAsset() {
                    try {
                        const res = await fetch('/api/asset/browse/');
                        const data = await res.json();
                        if (data.status === 'success') {
                            this.formData.asset_type = data.path;
                        }
                    } catch (e) {
                        console.error("Error exploring assets:", e);
                    }
                },

                async browseSceneAudio() {
                    try {
                        const res = await fetch('/api/asset/browse/?type=audio');
                        const data = await res.json();
                        if (data.status === 'success') {
                            this.formData.audio = data.path;
                        }
                    } catch (e) {
                        alert("Error abriendo buscador: " + e);
                    }
                }

            }));
        });
    </script>

    <!-- RECORDING MODAL -->
    <div x-show="showRecordModal" style="display: none;"
        class="fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center z-[60] p-4" x-transition
        x-cloak>
        <div class="bg-gray-900 border border-red-500/50 rounded-xl shadow-[0_0_50px_rgba(239,68,68,0.2)] w-full max-w-sm overflow-hidden animate-scale"
            @click.away="cancelRecording()">

            <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-800/50">
                <h3 class="text-lg font-bold text-red-400">üéôÔ∏è Grabadora de Voz</h3>
                <button @click="cancelRecording()" class="text-gray-500 hover:text-white">&times;</button>
            </div>

            <div class="p-8 flex flex-col items-center gap-6">
                <!-- Recording Animation / Timer -->
                <div class="relative w-24 h-24 flex items-center justify-center">
                    <template x-if="isRecording">
                        <div class="absolute inset-0 bg-red-500/20 rounded-full animate-ping"></div>
                    </template>
                    <div class="z-10 text-4xl" :class="isRecording ? 'text-red-500' : 'text-gray-600'">üéôÔ∏è</div>
                </div>

                <div class="text-center">
                    <p class="text-2xl font-mono text-white" x-text="'00:' + String(recordingTimer).padStart(2, '0')">
                    </p>
                    <p class="text-xs text-gray-500 uppercase mt-1"
                        x-text="isRecording ? 'Grabando...' : (audioPreviewUrl ? 'Grabaci√≥n completa' : 'Listo para grabar')">
                    </p>
                </div>

                <!-- Preview Audio -->
                <template x-if="audioPreviewUrl">
                    <audio x-ref="audioPreview" :src="audioPreviewUrl" controls
                        class="w-full h-8 brightness-90"></audio>
                </template>

                <!-- Controls -->
                <div class="flex gap-4 w-full mt-4">
                    <template x-if="!isRecording && !audioPreviewUrl">
                        <button @click="startRecording()"
                            class="flex-1 bg-red-600 hover:bg-red-500 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition transform active:scale-95">
                            üî¥ Iniciar
                        </button>
                    </template>

                    <template x-if="isRecording">
                        <button @click="stopRecording()"
                            class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition transform active:scale-95 border border-red-500/50">
                            ‚èπÔ∏è Detener
                        </button>
                    </template>

                    <template x-if="audioPreviewUrl">
                        <div class="flex gap-2 w-full">
                            <button @click="audioChunks = []; audioPreviewUrl = null; startRecording()"
                                class="flex-1 bg-gray-800 hover:bg-gray-700 text-gray-300 py-3 rounded-lg font-bold text-sm transition">
                                Reintentar
                            </button>
                            <button @click="uploadRecording()" :disabled="isSaving"
                                class="flex-1 bg-green-600 hover:bg-green-500 text-white py-3 rounded-lg font-bold text-sm shadow-lg shadow-green-500/20 transition transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span x-show="!isSaving">‚úÖ Usar Audio</span>
                                <span x-show="isSaving" class="flex items-center justify-center gap-2">
                                    <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg"
                                        fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor"
                                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                        </path>
                                    </svg>
                                    Subiendo...
                                </span>
                            </button>
                        </div>
                    </template>
                </div>
            </div>

            <div class="p-4 bg-gray-950/50 border-t border-gray-800 text-[10px] text-gray-500 text-center">
                El audio se guardar√° como asset y se asignar√° autom√°ticamente a la escena.
            </div>
        </div>
    </div>

    <!-- BULK TEXT EDITOR MODAL -->

    <div x-show="showBulkModal" style="display: none;"
        class="fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center z-50 p-4" x-transition
        x-cloak>
        <div class="bg-gray-900 border border-indigo-500/50 rounded-xl shadow-[0_0_50px_rgba(79,70,229,0.3)] w-full max-w-5xl h-[85vh] flex flex-col overflow-hidden animate-scale"
            @click.away="if (!showRecordModal) showBulkModal = false">

            <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-800/50">
                <div>
                    <h3 class="text-lg font-bold text-indigo-400">üìù Editor de Guion Pro (Texto)</h3>
                    <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Formato: T√≠tulo | Asset |
                        Efectos | Texto | Pausa</p>
                </div>
                <div class="flex gap-2">
                    <button @click="showBulkModal = false"
                        class="text-gray-400 hover:text-white px-3 py-1 rounded text-sm transition">Cancelar</button>
                    <button @click="saveBulkEditor()"
                        class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg shadow-indigo-500/20 transition transform active:scale-95">
                        ‚úÖ Aplicar Cambios
                    </button>
                </div>
            </div>

            <div class="flex-1 p-4 bg-gray-950 relative">
                <textarea x-model="bulkText"
                    class="w-full h-full bg-transparent text-gray-300 font-mono text-sm p-4 focus:ring-0 border-none resize-none leading-relaxed"
                    placeholder="Escribe tu guion aqu√≠..."></textarea>

                <div
                    class="absolute bottom-6 right-8 text-[10px] text-gray-600 font-mono space-y-1 bg-gray-900/80 p-3 rounded border border-gray-800 pointer-events-none">
                    <p>üìå TIP: Usa [SFX: nombre | vol | off] para efectos.</p>
                    <p>üìå TIP: Usa [OVERLAY: nombre] para capas visuales.</p>
                    <p>üìå TIP: Usa [SUB: palabras | texto] para subt√≠tulos manuales.</p>
                </div>
            </div>

            <div class="px-4 py-2 bg-gray-900/50 border-t border-gray-800 text-[10px] text-yellow-500/70 italic">
                ‚ö†Ô∏è Al aplicar, el sistema regenerar√° la estructura visual. Aseg√∫rate de respetar el formato de columnas
                (|).
            </div>
        </div>
    </div>
    <script>
        // Heartbeat mechanism to keep server alive (CRITICAL for Standalone Editor)
        function sendHeartbeat() {
            fetch("{% url 'generator:api_heartbeat' %}")
                .then(response => response.json())
                .catch(err => console.debug("Heartbeat failed (server might be down)"));
        }
        setInterval(sendHeartbeat, 10000); // 10s
        document.addEventListener('DOMContentLoaded', sendHeartbeat);
    </script>
</body>

</html>