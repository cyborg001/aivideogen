{% extends 'generator/base.html' %}
{% block content %}
<h1>Crear Nuevo Video</h1>
<div class="card">
    <form method="post">
        {% csrf_token %}
        <label>T√≠tulo del Proyecto:</label>
        <input type="text" name="title" id="project-title" required placeholder="Mi Video Genial" value="{{ retry_data.title|default:initial_title }}">

        <label>Motor de Voz:</label>
        <select name="engine">
            <option value="edge" {% if retry_data.engine == 'edge' or not retry_data.engine %}selected{% endif %}>Edge TTS (Gratis)</option>
            <option value="elevenlabs" {% if retry_data.engine == 'elevenlabs' %}selected{% endif %}>ElevenLabs (Requiere API Key)</option>
        </select>

        <label>Formato de Video:</label>
        <select name="aspect_ratio">
            <option value="landscape" {% if retry_data.aspect_ratio == 'landscape' or not retry_data.aspect_ratio %}selected{% endif %}>Horizontal (YouTube 16:9)</option>
            <option value="portrait" {% if retry_data.aspect_ratio == 'portrait' %}selected{% endif %}>Vertical (YouTube Shorts / TikTok 9:16)</option>
        </select>

        <label>ID de Voz o Nombre (Opcional):</label>
        <input type="text" name="voice_id" placeholder="Ej: es-ES-AlvaroNeural o JBFqnCBsd6RMkjVDRZzb" value="{{ retry_data.voice_id|default:'' }}">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <label>M√∫sica de Fondo:</label>
                <select name="background_music">
                    <option value="">Sin m√∫sica</option>
                    {% for music in all_music %}
                    <option value="{{ music.id }}" {% if retry_data.background_music_id == music.id %}selected{% endif %}>{{ music.name }}</option>
                    {% endfor %}
                </select>
                <p style="font-size: 0.8rem; color: #aaa; margin-top: 5px;">
                    Gestiona tu m√∫sica en la secci√≥n de <a href="{% url 'generator:music_list' %}"
                        style="color: #03dac6;">Audio Hub</a>
                </p>
            </div>
            <div>
                <label>Volumen de M√∫sica: <span id="vol-label">{% if retry_data.music_volume_percent %}{{ retry_data.music_volume_percent }}{% else %}15{% endif %}%</span></label>
                <input type="range" name="music_volume" min="0" max="1" step="0.05" value="{{ retry_data.music_volume|default:0.15 }}"
                    oninput="document.getElementById('vol-label').innerText = Math.round(this.value * 100) + '%'">
            </div>
        </div>


        <!-- Selector Visual -->
        <div
            style="background: #2d2d2d; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #444;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0; font-size: 1rem;">üìÅ Selecci√≥n de Archivos</h3>
                <button type="button" class="btn" style="background-color: #03dac6; color: #000;"
                    onclick="browseFile()">
                    üìÇ Seleccionar Guion del Disco
                </button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label style="font-size: 0.8rem; color: #aaa;">Carpeta de Assets (Autom√°tica):</label>
                    <input type="text" name="source_path" id="source_path" placeholder="Esperando selecci√≥n..." readonly
                        style="background-color: #222; cursor: not-allowed;">
                </div>
                <div>
                    <label style="font-size: 0.8rem; color: #aaa;">Archivo de Guion:</label>
                    <input type="text" name="script_file" id="script_file" placeholder="Esperando selecci√≥n..." readonly
                        style="background-color: #222; cursor: not-allowed;">
                </div>
            </div>
            
            <div style="margin-top: 10px;">
                <label style="font-size: 0.8rem; color: #aaa;">Hashtags (Para YouTube):</label>
                <input type="text" name="script_hashtags" id="script_hashtags" 
                    placeholder="#IA #Tecnologia #Futuro" 
                    value="{{ retry_data.script_hashtags|default:ai_hashtags }}"
                    style="background-color: #222; color: #03dac6; border: 1px solid #444;">
            </div>
        </div>

        <script>
            function browseFile() {
                fetch("{% url 'generator:browse_script' %}")
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            document.getElementById('source_path').value = data.path;
                            document.getElementById('script_file').value = data.filename;
                            
                            // Update textarea
                            const editor = document.getElementById('script-editor');
                            editor.value = data.content;
                            
                            // Trigger analytics & title extraction
                            updateAnalytics();
                        } else if (data.status === 'error') {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(err => alert('Error de conexi√≥n: ' + err));
            }
        </script>

        <label>AVGL v4.0 (JSON Format) - Motor Robusto y Validable:</label>
        <p style="font-size: 0.85rem; color: #aaa; margin: 5px 0 15px 0; line-height: 1.5;">
            üìå <b>FORMATO JSON ESTRUCTURADO:</b><br>
            ‚Ä¢ <b>Root:</b> <code>{"title": "...", "voice": "...", "blocks": [...]}</code><br>
            ‚Ä¢ <b>Block:</b> Cap√≠tulos con m√∫sica: <code>{"title": "...", "music": "...", "scenes": [...]}</code><br>
            ‚Ä¢ <b>Scene:</b> Escenas con texto y assets: <code>{"title": "...", "text": "...", "assets": [...]}</code><br>
            ‚Ä¢ <b>Assets:</b> Ken Burns: <code>{"type": "img.png", "zoom": "1.0:1.3", "overlay": "dust"}</code><br>
            ‚Ä¢ <b>SFX:</b> Efectos de sonido: <code>{"type": "whoosh", "volume": 0.5, "offset": 0}</code><br>
            üìò <a href="/docs/AVGL_MANUAL_v4_JSON.md" target="_blank" style="color: #03dac6;">Ver Manual Completo</a> | 
            üìã <a href="/docs/AVGL_CHEATSHEET_v4_JSON.md" target="_blank" style="color: #03dac6;">CheatSheet</a>
        </p>

        <!-- NEW: AI Visual Prompts Section -->
        {% if ai_visual_prompts %}
        <div
            style="background: rgba(3, 218, 198, 0.1); padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px dashed #03dac6;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0; font-size: 1rem; color: #03dac6;">‚ú® Prompts Visuales Sugeridos</h3>
                <button type="button" class="btn" style="padding: 5px 10px; font-size: 0.8rem;"
                    onclick="copyPrompts()">Copiar</button>
            </div>
            <textarea id="ai-prompts" name="visual_prompts" rows="6"
                style="background: rgba(0,0,0,0.2); font-size: 0.85rem; border-color: rgba(3, 218, 198, 0.3);">{{ ai_visual_prompts }}</textarea>
            <script>
                function copyPrompts() {
                    const el = document.getElementById('ai-prompts');
                    el.select();
                    document.execCommand('copy');
                    alert('Prompts copiados');
                }
            </script>
        </div>
        {% endif %}

        <!-- Script Analytics Bar -->
        <div id="analytics-bar"
            style="background: #1e1e1e; padding: 10px; border-radius: 5px 5px 0 0; border: 1px solid #444; border-bottom: none; display: flex; gap: 20px; font-size: 0.9rem;">
            <span>üìù Palabras: <b id="word-count">0</b></span>
            <span>‚è±Ô∏è Duraci√≥n Est.: <b id="est-duration">0m 0s</b></span>
            <span style="color: #03dac6;">üß™ Motor: <b>AVGL v4.0 JSON</b></span>
        </div>

        <textarea id="script-editor" name="script" rows="15"
            style="font-family: monospace; border-top-left-radius: 0; border-top-right-radius: 0;">{{ default_script }}</textarea>

        <script>
            function updateAnalytics() {
                const text = document.getElementById('script-editor').value.trim();
                let totalWords = 0;
                let isJson = false;

                // 1. TRY JSON FORMAT (AVGL v4.0)
                if (text.startsWith('{')) {
                    try {
                        let data = JSON.parse(text);
                        isJson = true;

                        // Support AI Wrapper format (contains "script" key)
                        if (data.script && typeof data.script === 'object') {
                            data = data.script;
                        }

                        // Auto-fill Title (Always update if present in JSON)
                        const titleInput = document.getElementById('project-title');
                        if (data.title) {
                            titleInput.value = data.title;
                        }

                        // Auto-fill Voice Logic
                        if (data.voice) {
                            // Check if standard voice (Edge vs Eleven)
                            // Ideally we just put it in voice_id field
                            const voiceInput = document.querySelector('input[name="voice_id"]');
                            // Only overwrite if empty or user just pasted
                            if (voiceInput) {
                                voiceInput.value = data.voice;
                            }
                        }

                        // Auto-fill Hashtags
                        if (data.hashtags) {
                             const tagsInput = document.getElementById('script_hashtags');
                             if (tagsInput) {
                                 let tagsVal = Array.isArray(data.hashtags) ? data.hashtags.join(' ') : data.hashtags;
                                 tagsInput.value = tagsVal;
                             }
                        }

                        // Count Words
                        if (data.blocks) {
                            data.blocks.forEach(block => {
                                if (block.scenes) {
                                    block.scenes.forEach(scene => {
                                        if (scene.text) {
                                            let clean = scene.text.replace(/\[.*?\]/g, ' '); // Remove emotion tags
                                            clean = clean.replace(/<[^>]+>/g, ' '); // Remove SSML if any
                                            const words = clean.split(/\s+/).filter(w => w.length > 0);
                                            totalWords += words.length;
                                        }
                                    });
                                }
                            });
                        }
                        
                        // Update Engine Indicator
                        const engineLabel = document.getElementById('analytics-bar').querySelector('span:last-child');
                        if (engineLabel) engineLabel.innerHTML = 'üß™ Motor: <b>AVGL v4.0 JSON</b>';

                    } catch (e) {
                        // Invalid JSON, ignore
                    }
                }

                // 2. LEGACY LOGIC (If not JSON)
                if (!isJson) {
                    // Title from <avgl title="...">
                    const avglMatch = text.match(/<avgl\s+title="([^"]+)"/i);
                    if (avglMatch && avglMatch[1]) {
                        document.getElementById('project-title').value = avglMatch[1];
                    }

                    // Count from <scene> tags
                    const sceneRegex = /<scene[^>]*>(.*?)<\/scene>/gis;
                    let match;
                    while ((match = sceneRegex.exec(text)) !== null) {
                        let content = match[1];
                        let cleanText = content.replace(/<[^>]+>/g, ' ');
                        cleanText = cleanText.replace(/\[.*?\]/g, ' ');
                        const words = cleanText.split(/\s+/).filter(w => w.length > 0);
                        totalWords += words.length;
                    }
                    
                    // Reset indicator
                    const engineLabel = document.getElementById('analytics-bar').querySelector('span:last-child');
                    if (engineLabel) engineLabel.innerHTML = 'üìú Motor: <b>Legacy XML</b>';
                }

                // Update Stats UI
                document.getElementById('word-count').innerText = totalWords;
                const totalSeconds = Math.round((totalWords / 140) * 60); // Approx 140 wpm
                const mins = Math.floor(totalSeconds / 60);
                const secs = totalSeconds % 60;
                document.getElementById('est-duration').innerText = `${mins}m ${secs}s`;
            }

            // Listen for typing
            document.getElementById('script-editor').addEventListener('input', updateAnalytics);

            // Initial run
            window.addEventListener('load', function () {
                setTimeout(updateAnalytics, 100);
            });
        </script>

        <div style="background: rgba(255, 0, 0, 0.1); padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid rgba(255, 0, 0, 0.3); display: flex; align-items: center; gap: 15px;">
            <input type="checkbox" name="auto_upload_youtube" id="auto_upload" style="width: 25px; height: 25px; margin: 0; cursor: pointer;">
            <label for="auto_upload" style="margin: 0; cursor: pointer; font-weight: bold; color: #ff5252;">üöÄ Subir autom√°ticamente a YouTube al finalizar</label>
        </div>

        <button type="submit" class="btn">Generar Video</button>
    </form>
</div>

<script>
    // ==========================================
    // LIVE SYNC: UI MUSIC -> JSON SCRIPT
    // ==========================================
    document.addEventListener('DOMContentLoaded', function() {
        const musicSelect = document.querySelector('select[name="background_music"]');
        const volInput = document.querySelector('input[name="music_volume"]');
        const editor = document.getElementById('script-editor');

        function updateScriptJson() {
            try {
                const text = editor.value;
                if (!text.trim().startsWith('{')) return; // Only if JSON
                
                let json = JSON.parse(text);
                
                // Get selected music name
                if (musicSelect.selectedIndex > 0) { // If not "Sin m√∫sica"
                     const selectedOption = musicSelect.options[musicSelect.selectedIndex];
                     json.background_music = selectedOption.text.trim();
                     json.music_volume = parseFloat(volInput.value);
                     
                     // Write back nicely formatted
                     editor.value = JSON.stringify(json, null, 4);
                }
            } catch (e) {
                // Ignore parsing errors while typing
            }
        }

        // Listen for UI changes
        if (musicSelect) musicSelect.addEventListener('change', updateScriptJson);
        if (volInput) volInput.addEventListener('change', updateScriptJson);
    });
</script>

<script>
    // ======================================================
    // FORM PERSISTENCE - REMOVED (v2.21.0)
    // ======================================================
    // Previous behavior: localStorage saved form data between sessions
    // New behavior: Always fresh start when accessing /create/
    // Exception: Continuing a canceled project works via server-side template
    
    // Note: {{ default_script }} is injected by Django template
    // All other fields start blank every time
</script>
{% endblock %}